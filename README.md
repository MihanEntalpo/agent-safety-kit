# Agent Safety Kit

Набор инструментов для запуска AI-агентов в изолированной среде внутри виртуальной машины Multipass.

## Ключевые идеи
- Виртуальная машина запускается через Multipass и служит основным окружением для агента.
- Внутрь ВМ монтируются проектные папки из указанной пользователем директории; параллельно запускается автоматическое резервное копирование в соседнюю папку с настраиваемой частотой (по умолчанию раз в пять минут и только при изменениях), использующее `rsync` и hardlink'и для экономии места.
- При старте виртуальной машины можно передать и закрепить нужные переменные окружения для агента.
- Агент можно запускать, не входя в гостевую систему через `multipass shell` — фактически он всё равно исполняется внутри ВМ.

Подробнее о процессе работы и текущих задачах см. в `workflow.md`.

## Быстрый старт

1. Установите Multipass в deb-based окружении:
   ```bash
   ./install_multipass.sh
   ```
   Скрипт требует доступности `apt` и сообщает, если дистрибутив не поддерживается.
2. Подготовьте файл окружения для будущей ВМ:
   ```bash
   cp example.env .env
   # при необходимости отредактируйте значения
   ```
   В `.env` должны быть заданы параметры машины (имя, CPU, память, диск).
3. Создайте виртуальную машину или убедитесь, что её параметры совпадают с ожиданиями:
   ```bash
   ./create_vm.sh
   ```
   Если ВМ уже существует, скрипт сравнит заданные в `.env` ресурсы с текущими, сообщит об отличающихся параметрах и отметит, что изменение уже созданной ВМ пока не поддерживается.

## Резервное копирование

### Разовая резервная копия

`libs/make_single_backup.sh` — однократный запуск резервного копирования исходной директории в указанную папку с помощью `rsync`.
Скрипт создаёт каталог с отметкой времени и суффиксом `-partial`, поддерживает инкрементальные копии через `--link-dest` на предыдущий бэкап и учитывает списки исключений из `.backupignore` и аргументов `--exclude`. После завершения выполнения временная папка переименовывается в финальную с тем же timestamp без суффикса. Если изменений относительно последнего бэкапа нет, новый снапшот не создаётся, и утилита сообщает об отсутствии обновлений.

Примеры строк для `.backupignore`:
- `venv/`, `node_modules/` — исключить виртуальные окружения и зависимости.
- `*.log`, `*.tmp` — игнорировать временные и лог-файлы по маске.
- `!logs/important.log` — вернуть в бэкап конкретный файл внутри исключённой папки.
- `docs/build/` — пропустить артефакты сборки документации.

Бэкап использует `rsync` с инкрементальными ссылками (`--link-dest`) на предыдущую копию: если изменился только небольшой набор файлов, в новой копии хранятся лишь изменённые данные, а неизменённые файлы представляют собой hardlink'и на прошлый снапшот. Это позволяет поддерживать цепочку датированных каталогов, занимая минимум места при редких изменениях.
