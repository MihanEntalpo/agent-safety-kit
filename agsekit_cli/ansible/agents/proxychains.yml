---
- name: Enable proxychains when requested
  block:
    - name: Install proxychains
      ansible.builtin.apt:
        update_cache: true
        name: proxychains4
      become: true

    - name: Parse proxychains URL
      ansible.builtin.set_fact:
        proxy_scheme: "{{ proxychains_url | regex_replace('://.*', '') }}"
        proxy_hostport: "{{ proxychains_url | regex_replace('^\\w+://', '') }}"

    - name: Validate proxychains URL
      ansible.builtin.assert:
        that:
          - proxy_scheme in ['socks5', 'socks4', 'http', 'https']
          - proxy_hostport is match('.+:[0-9]+$')
        fail_msg: "proxychains proxy must be in the form scheme://host:port"

    - name: Set proxychains parameters
      ansible.builtin.set_fact:
        proxy_type: "{{ 'http' if proxy_scheme in ['http', 'https'] else proxy_scheme }}"
        proxy_host: "{{ proxy_hostport | regex_replace(':[0-9]+$', '') }}"
        proxy_port: "{{ proxy_hostport | regex_replace('^.*:', '') }}"

    - name: Write proxychains config
      ansible.builtin.copy:
        dest: /tmp/agsekit-proxychains.conf
        mode: "0644"
        content: |
          strict_chain
          proxy_dns
          remote_dns_subnet 224
          tcp_read_time_out 15000
          tcp_connect_time_out 8000
          # proxychains-ng localnet accepts CIDR/mask ranges.
          localnet 127.0.0.0/255.0.0.0

          [ProxyList]
          {{ proxy_type }} {{ proxy_host }} {{ proxy_port }}

    - name: Set proxychains command prefix
      ansible.builtin.set_fact:
        proxychains_prefix: "proxychains4 -q -f /tmp/agsekit-proxychains.conf "
  when: proxychains_url is defined and proxychains_url | length > 0

- name: Disable proxychains when not requested
  ansible.builtin.set_fact:
    proxychains_prefix: ""
  when: proxychains_url is not defined or proxychains_url | length == 0
