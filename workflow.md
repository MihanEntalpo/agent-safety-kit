# Журнал задач и решений

## Задача: Подготовить рабочую структуру проекта для агентного запуска в Multipass
### Проблемы и blockers
- Блокирующих проблем по задаче не выявлено.
### Решения и заметки
- Описана стартовая структура проекта и связи с мультипасс-окружением.

## Задача: Задокументировать правила ведения workflow и общие инструкции
### Проблемы и blockers
- Блокирующих проблем по задаче не выявлено.
### Решения и заметки
- Добавлен файл `AGENTS.md` с требованиями к ведению этого журнала.
- Созданы симлинки `QWEN.md` и `CLAUDE.md`, указывающие на единый набор инструкций.
- Планируется дополнять журнал по мере появления новых задач и опыта.

## Задача: Настроить базовые скрипты установки Multipass и создания ВМ на основе конфигурации
### Проблемы и blockers
- Изменение параметров уже созданной ВМ пока не поддерживается и требует отдельной проработки.
### Решения и заметки
- Реализованы скрипты `install_multipass.sh` и `create_vm.sh`, пример конфигурации `example.env`, а также инструкции по использованию в `README.md`.
- Добавлена проверка конфигурации существующей ВМ с указанием несовпадающих параметров.

## Задача: Учесть комментарии по скриптам Multipass и документации
### Проблемы и blockers
- Блокирующих проблем по задаче не выявлено.
### Решения и заметки
- Вынесена функция загрузки переменных окружения в `lib/utils.sh` и подключена в `create_vm.sh`.
- Уточнены инструкции по работе со скриптами в `README.md`, включая сообщение о конкретных отличиях ресурсов при существующей ВМ.

## Задача: Добавить утилиту однократного резервного копирования
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Создан скрипт `libs/make_single_backup.sh` на Python, выполняющий копирование через `rsync`, поддерживающий инкременты через `--link-dest`, исключения из `.backupignore` и аргументов `--exclude`, а также финальное переименование каталога с временным суффиксом.
- README дополнен описанием внутренних утилитарных скриптов и новой утилиты.

## Задача: Добавить интеграционный тест для скрипта резервного копирования
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Написан интеграционный тест `tests/test_make_single_backup.py`, покрывающий сценарии исключений `.backupignore`, аргументы `--exclude`, очистку каталогов `-inprogress` и инкрементальные копии с hardlink'ами.

## Задача: Уточнить поведение инкрементального бэкапа и его тестов
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Скрипт резервного копирования создаёт временные каталоги с суффиксом `-partial` и удаляет их при перезапусках.
- Интеграционные тесты дополнены проверкой очистки незавершённых запусков и валидацией, что неизменённые файлы сохраняют один и тот же inode между снапшотами.

## Задача: Пропускать создание бэкапа при отсутствии изменений
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Перед копированием выполняется `rsync --dry-run` с анализом изменений; при их отсутствии выводится сообщение и новый снапшот не создаётся.
- Интеграционный тест проверяет, что повторный запуск без изменений не создаёт новую папку и оставляет директорию `dest` без `-partial` следов.

## Задача: Проверить поддержку всех основных паттернов `.backupignore`
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлен интеграционный тест, создающий временные структуры с вложенными `.backupignore`, масками, исключёнными директориями, якорными правилами и переопределениями через `!`.
- README дополнен разделом «Резервное копирование» и примерами паттернов для `.backupignore`.

## Задача: Покрыть несколькими вложенными `.backupignore`
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлен интеграционный тест, который создаёт и проверяет каскад из нескольких вложенных `.backupignore` (три уровня вложенности) и их комбинированные правила исключений/включений для файлов и директорий.

## Задача: Добавить логи и обработку ошибок в скрипт резервного копирования
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Скрипт бэкапа выводит явные логи очистки незавершённых снапшотов, запуска `rsync` и итогового создания каталога снапшота.
- Ошибки выводятся в stderr, завершаясь ненулевым кодом возврата; интеграционные тесты покрывают новые сообщения и поведение ошибок.

## Задача: Перейти на единую Python CLI с YAML-конфигурацией
### Проблемы и blockers
- Требовалось заменить bash-скрипты и env-конфигурацию на более расширяемый формат и общую точку входа.
### Решения и заметки
- Добавлен пример `config-example.yaml` и загрузчик конфигурации из YAML (путь можно задать через `CONFIG_PATH`).
- Создан Python-CLI `./agsekit` на базе `click` с командами `prepare`, `create-vm` и `backup-once` (резервное копирование перенесено в CLI).
- Bash-скрипты и `.env`-пример удалены; инструкции в README обновлены, добавлены зависимости в `requirements.txt` и шаги по созданию virtualenv.

## Задача: Учесть комментарии к README и примеру конфигурации
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- README дополнен шагом клонирования репозитория, комментариями и подсказками по умолчаниям `target`/`backup` в разделе YAML.
- Пример конфигурации `config-example.yaml` снабжён поясняющими комментариями по каждому полю.
- Примеры `.backupignore` оформлены единым блоком с комментариями внутри.

## Задача: Разделить README на русскую и английскую версии
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Русская документация перенесена в `README-ru.md`, добавлена кросс-ссылка на английскую версию.
- Создан английский `README.md` с эквивалентным содержанием и ссылкой на русскую версию.
- В `AGENTS.md` зафиксировано правило держать обе версии README в актуальном состоянии при правках.
- Комментарий в примере `config-example.yaml` обновлён с учётом переименованных README.

## Задача: Добавить циклическое резервное копирование и интервалы в конфиге
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлен Python-модуль циклических бэкапов с немедленным стартом, сообщением `Done, waiting N minutes` и проверкой положительного интервала.
- Конфигурация `mounts` поддерживает поле `interval` с умолчанием 5 минут, снабжена валидацией и примером в `config-example.yaml`.
- В CLI появились команды `backup-repeated`, `backup-repeated-mount` и `backup-repeated-all`; README/README-ru дополнены описанием новых параметров и команд.

## Задача: Уточнить документацию циклических бэкапов и покрыть новые команды тестами
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Скорректированы комментарии в README, подчёркивающие интервалы по умолчанию и способы указания пути к конфигу.
- Зафиксировано правило добавлять новые задачи в конец `workflow.md`.
- Добавлены автотесты для CLI-команд циклического бэкапа, покрывающие поиск монтирования, ошибки отсутствующих записей и запуск параллельных циклов.

## Задача: Добавить поддержку нескольких ВМ и проверку ресурсов перед созданием
### Проблемы и blockers
- Требовалось пересобрать конфигурацию под несколько ВМ и учесть ограничения ресурсов хоста.
### Решения и заметки
- Конфиг переведён на раздел `vms` с параметрами нескольких машин и привязкой монтирований к конкретной ВМ.
- CLI получил команды `create-vm <имя>` и `create-vms`, перед созданием выполняется проверка, что после выделения ресурсов останется минимум 1 CPU и 1 ГБ RAM.
- Добавлены валидации для настроек монтирований и примеры/документация обновлены в обоих README и `config-example.yaml`.

## Задача: Добавить команды mount и umount для управления монтированиями
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- CLI пополнен командами `mount` и `umount`, которые принимают путь `--source-dir` или флаг `--all` и читают настройки монтирований из YAML-конфигурации (`config.yaml`, `CONFIG_PATH` или `--config`).
- Реализована общая логика загрузки монтирований и вызовов `multipass mount/umount`, покрытая интеграционными тестами для CLI.
- Документация на русском и английском дополнена описанием новых команд.

## Задача: Добавить шаг монтирования в инструкцию быстрого старта
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- В разделах Quick start/Быстрый старт README добавлен пункт о запуске `./agsekit mount --all` для монтирования заранее настроенных папок.

## Задача: Добавить конфигурацию и команды для работы с агентами
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- Конфигурация YAML расширена секцией `agents` с типами qwen/codex/claude, прокси и переменными окружения.
- Добавлены команды CLI `install-agents` для установки агентов в ВМ и `run` для запуска агента с прокси, переменными окружения и фоновыми бэкапами.
- README и README-ru дополнены описанием новых опций и примерами использования.

## Задача: Уточнить комментарии к установке и запуску агентов
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- Уточнены комментарии по типам агентов и прокси в примере YAML и README.
- Обновлены скрипты установки агентов для codex-cli, qwen-code и claude-code реальными командами.
- В quickstart добавлен шаг установки всех агентов в их ВМ по умолчанию.

## Задача: Убрать упоминание прокси из описания команды run
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- Описание `./agsekit run` в README и README-ru приведено в соответствие текущей реализации без упоминания прокси.

## Задача: Добавить англоязычные сообщения CLI и уточнить установку агентов
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Команды CLI выводят поясняющие сообщения перед выполнением действий (установка зависимостей, создание ВМ, монтирование, бэкапы, запуск агентов) и логируют фоновые бэкапы.
- Добавлена проверка наличия бинарника агента в выбранной ВМ с понятной подсказкой о необходимости `install-agents`.
- Скрипт установки qwen-code устанавливает Node.js/npm через apt при отсутствии и сообщает об ошибке, если npm всё ещё недоступен.
- README и README-ru синхронизированы: обновлены команды клонирования и virtualenv, добавлены шаги про циклические бэкапы и пример запуска агента в быстром старте.

## Задача: Уточнить установку qwen-code через nvm
### Проблемы и blockers
- Требовалось установить Node.js корректной версией без зависимости от системных пакетов.
### Решения и заметки
- Скрипт установки qwen-code ставит nvm при отсутствии Node.js, загружает его окружение и устанавливает Node.js 24 с выводом версий.
- При отсутствии npm после установки выводится понятная ошибка о необходимости ручной установки Node.js/nvm.

## Задача: Пропускать подготовку, если Multipass уже установлен
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Команда `prepare` проверяет наличие Multipass и при установленном бинарнике пропускает шаги `apt-get` и установки.

## Задача: Искать корректный бинарник Qwen при запуске агента
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Тип агента qwen теперь приводит к вызову бинарника `qwen` (ранее искали `qwen-code`), обновлены примеры конфигурации и тесты.

## Задача: Поправить комментарии к типу агента qwen-code
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- Примеры конфигурации в README и config-example.yaml оставляют тип `qwen-code`, уточняя, что используется бинарник `qwen`.

## Задача: Добавить интерактивный режим запуска CLI
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- Добавлен интерактивный режим, который запускается в TTY при отсутствии или нехватке аргументов и предлагает выбрать команду и параметры из конфигурации.
- Расширен requirements новым зависимым пакетом `questionary` для отображения списков выбора и подтверждений.

## Задача: Покрыть интерактивный режим тестами
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлены pytest-тесты, проверяющие запуск интерактивного режима при отсутствии аргументов или нехватке параметров и сохранение стандартного вывода помощи в неинтерактивной среде.
- Покрыт сценарий успешного выполнения интерактивного вызова команды без выхода из процесса.

## Задача: Добавить флаг принудительно неинтерактивного режима
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- Во все команды CLI добавлен параметр `--non-interactive`, который отключает автоматический запуск интерактивного режима.
- Основной вход CLI учитывает флаг, избегая перехода в интерактивный режим даже в TTY при нехватке аргументов.
- Добавлены тесты, проверяющие отсутствие интерактивного режима при использовании нового флага.

## Задача: Уточнить порядок выбора ВМ при установке агента
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- В интерактивном режиме при установке агента сначала предлагается ВМ по умолчанию с указанием её имени, затем список доступных ВМ и опция выбора всех ВМ.

## Задача: Исправить выбор ВМ по умолчанию при установке агентов
### Проблемы и blockers
- В интерактивном режиме выбор варианта "Использовать ВМ по умолчанию" передавался как позиционный аргумент, что конфликтовало с флагом `--all-agents` и вызывало ошибку CLI.
### Решения и заметки
- Опция выбора ВМ по умолчанию получила отдельное значение, исключающее добавление позиционного аргумента в команду `install-agents`.

## Задача: Уточнить окружение для qwen, .gitignore и версию Python
### Проблемы и blockers
- Бинарник qwen устанавливается через nvm и не попадал в PATH при запуске агента, из-за чего CLI не находил `qwen` внутри ВМ.
- Несколько пользовательских файлов (`.python-version`, `config.yaml`, `venv/` и кэши) не игнорировались git'ом.
- В README отсутствовало требование к минимальной версии Python.
### Решения и заметки
- Команды запуска агента теперь предварительно загружают окружение nvm, чтобы `qwen` был доступен в PATH внутри ВМ.
- `.gitignore` дополнен путями к локальному окружению и файлам конфигурации.
- В обоих README указана минимальная поддерживаемая версия Python (3.10+).

## Задача: Добавить qwen в PATH при установке
### Проблемы и blockers
- После установки через nvm бинарник `qwen` оказывался вне стандартного PATH при неинтерактивном запуске.
### Решения и заметки
- Скрипт установки qwen создаёт ссылку на глобальный бинарник в доступном каталоге (`/usr/local/bin` либо `~/.local/bin`) и при необходимости добавляет `~/.local/bin` в PATH через `~/.profile`.

## Задача: Исправить установку qwen при отсутствии команды `npm bin`
### Проблемы и blockers
- Установка агента прерывалась на npm 11 из-за отсутствия команды `npm bin`, используемой для поиска каталога глобальных бинарников.
### Решения и заметки
- Скрипт установки qwen определяет путь глобальных бинарников через `npm prefix -g` и завершается с понятной ошибкой, если префикс недоступен.

## Задача: Перенаправить логи бэкапов и запускать агента из рабочей директории
### Проблемы и blockers
- Логи фоновых бэкапов выводились в stdout процесса, что мешало основному выводу агента.
- Запуск агента в ВМ требовал гарантированного перехода в рабочую директорию, чтобы не передавать путь проектной папки в качестве аргумента.
### Решения и заметки
- Фоновые процессы резервного копирования пишут stdout/stderr в файл `backup.log` в каталоге бэкапов, создавая директорию при необходимости и закрывая лог при завершении.
- Команда `run` выполняет агент внутри Multipass c явным `--workdir` и сменой каталога перед запуском бинарника агента.

## Задача: Исправить передачу ВМ по умолчанию в интерактивном режиме запуска
### Проблемы и blockers
- При выборе опции "Определить автоматически" интерактивный режим передавал её как явное имя ВМ, что ломало поиск монтирования.
### Решения и заметки
- Значение авто-выбора теперь заменяется на служебный код и не передаётся как аргумент `--vm`.
- Добавлен тест, который проверяет сбор аргументов `run` без явного флага `--vm` при авто-выборе.

## Задача: Убрать несовместимый флаг `--workdir` из команды запуска агента
### Проблемы и blockers
- В текущей версии Multipass опция `--workdir` для `multipass exec` не поддерживается, из-за чего запуск агента падал с ошибкой "Unknown option 'workdir'".
### Решения и заметки
- Аргумент `--workdir` убран из вызова `multipass exec`, при этом переход в рабочую директорию сохраняется через команду `cd` внутри запускаемого шелла.
- Добавлен тест, гарантирующий отсутствие флага `--workdir` и сохранение перехода в каталог при формировании команды.

## Задача: Добавить флаг `--debug` для вывода исполняемых команд при запуске агента
### Проблемы и blockers
- Пользователь не видел, какие внешние команды вызываются при запуске агента, из-за чего сложно понимать причину сбоев.
### Решения и заметки
- Во все вызовы Multipass и фоновых бэкапов, инициируемых командой `run`, добавлен опциональный вывод запускаемых команд.
- Команда `run` принимает флаг `--debug`, передавая его в проверки наличия бинарника агента, запуск фонового бэкапа и основной вызов агента внутри ВМ.
- Документация в README и README-ru дополнена описанием нового флага.

## Задача: Не задавать socks-прокси qwen с неподдерживаемой схемой
### Проблемы и blockers
- При передаче переменных `HTTP_PROXY=socks5://...` агент qwen возвращает ошибку о необходимости схемы http/https.
### Решения и заметки
- Логика формирования окружения для агента пропускает установку socks-прокси для qwen, если схема прокси не http/https.
- Добавлен тест для запуска с типом агента, отличным от qwen, чтобы подтвердить сохранение прежнего поведения прокси.

## Задача: Добавить блок об интерактивном режиме в README
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- README и README-ru дополнены описанием интерактивного режима CLI с примерами запуска через пустой вызов `./agsekit` и автоматического перехода при нехватке аргументов.

## Задача: Добавить команду shell для входа в ВМ
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- CLI получила команду `shell`, которая подключается к указанной ВМ, выбирает единственную ВМ по умолчанию или предлагает выбор при наличии нескольких записей в конфиге.
- README и README-ru дополнены инструкциями по новой команде.
- Добавлены тесты для проверки выбора ВМ, интерактивного режима и работы флага `--non-interactive`.

## Задача: Уточнить описание запуска агента в README
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Формулировки шагов запуска агента в README и README-ru уточнены, чтобы явно указывать каталог монтирования `/host/path/project`.

## Задача: Переименовать команду установки агентов
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Команда CLI переименована в `install-agents`, изменения отражены в коде, интерактивном меню и документации.

## Задача: Добавить команду остановки ВМ
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- CLI получила команду `stop`, которая умеет останавливать одну указанную ВМ или все ВМ из конфигурации через `--all-vms`.
- Команда доступна в интерактивном меню и задокументирована в обоих README с примерами вызова.

## Задача: Обновить порядок поиска конфигурации и интерактивное поведение при её отсутствии
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Конфигурация по умолчанию ищется в `~/.config/agsekit/config.yaml`, приоритет отдаётся аргументу `--config`, затем `CONFIG_PATH`.
- В интерактивном терминале при отсутствии конфигурации CLI переключается в интерактивный режим с подсказкой указать путь; в неинтерактивном режиме выводится ошибка.
- Документация на обоих языках обновлена, чтобы отражать новый путь по умолчанию и порядок поиска.

## Задача: Уточнить список шагов быстрого старта и выделить блок команд
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- В quick start убраны лишние пункты про бэкапы, shell и остановку ВМ; после установки агентов сразу показывается запуск агента.
- Добавлен раздел «Команды agsekit»/“agsekit commands” с группами команд по настройке, монтированию, бэкапам, установке и запуску агентов и интерактивному режиму в обеих README.

## Задача: Уточнить пример запуска агента в быстром старте
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Из примеров запуска в README и README-ru убран параметр `-- --help`, чтобы демонстрация соответствовала обычному вызову агента.

## Задача: Добавить интерактивный генератор конфигурации
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Реализована команда `config-gen`, которая задаёт вопросы о ВМ, монтированиях и агентах и сохраняет YAML в выбранный путь (по умолчанию `~/.config/agsekit/config.yaml`), предупреждая о существующем файле без флага `--overwrite`.
- README и README-ru дополнены упоминанием нового способа создания конфига в разделе быстрого старта.

## Задача: Упростить команды при единственном доступном варианте
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Команды `create-vm`, `stop`, `mount`, `umount`, `backup-repeated-mount` и `install-agents` автоматически используют единственную запись из конфигурации, если аргументы не указаны.
- Документация в README и README-ru дополнена подсказками об автоматическом выборе единственного варианта и об отсутствии необходимости указывать параметры в таких случаях.

## Задача: Добавить прогресс бэкапов и первичный запуск перед агентом
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Разовый бэкап прокидывает флаги прогресса rsync и выводит собственный прогресс-бар; опция доступна через `--progress`.
- Циклический бэкап получил флаг `--skip-first`, позволяющий начать цикл с ожидания интервала без немедленного копирования.
- При запуске агента с включёнными бэкапами проверяется наличие снимков; если их нет, выполняется первичный бэкап с прогрессом, а повторяющийся бэкап стартует с пропуском первого цикла. README и README-ru дополнены напоминанием дождаться первого бэкапа.

## Задача: Покрыть реальный прогресс rsync интеграционным тестом
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлен автотест, который запускает `rsync` с реальным переносом данных, считывает вывод прогресса и проверяет отображение процентного индикатора.

## Задача: Предупредить о путях монтирования с не-ASCII символами
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- README и README-ru дополнены примечанием, что для путей монтирования лучше использовать только ASCII-символы, иначе AppArmor может запретить монтирование.

## Задача: Перейти на pyproject.toml и установить agsekit как бинарь
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Проект переведён на сборку через `pyproject.toml` с setuptools, версия пакета обновлена до 0.5.0 и добавлен консольный скрипт `agsekit`.
- `requirements.txt` удалён, установка выполняется через `pip install .` из виртуального окружения; инструкции в README и README-ru обновлены.
- Запуск фоновых бэкапов использует установленный исполняемый файл `agsekit` с резервным поиском локального скрипта.

## Задача: Уточнить автора в pyproject.toml
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- В `pyproject.toml` указан автор проекта с адресом `mihanentalpo@yandex.ru` в поле `authors`.

## Задача: Добавить установку codex и сборку codex-glibc
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Скрипт установки `codex` устанавливает Node.js через nvm при необходимости, ставит `@openai/codex` глобально и прокладывает бинарник в PATH.
- Добавлен агент `codex-glibc`: скрипт ставит окружение Rust, собирает codex из репозитория с целевым glibc-таргетом и устанавливает бинарник `codex-glibc`.
- Конфигурация и README дополнены поддержкой новых типов агентов и алиасом `codex-cli`.

## Задача: Убрать синонимы qwen-code и codex-cli
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Поддержка типов ограничена базовыми значениями `qwen`, `codex`, `codex-glibc` и `claude-code`; синонимы `qwen-code` и `codex-cli` убраны.
- Значения по умолчанию в генераторе конфига и примере config.yaml переведены на тип `qwen`.
- Документация обновлена с учётом удаления синонимов.

## Задача: Добавить подробный вывод установки rustup для codex-glibc
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Процесс установки rustup разделён на скачивание скрипта и запуск в отдельной команде с выводом команд, чтобы видеть прогресс curl и установщика.

## Задача: Копировать актуальный скрипт установки агентов в ВМ перед запуском
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Команда установки агентов перед каждым запуском копирует скрипт в `/tmp` внутри ВМ с уникальным именем, что исключает использование устаревшего или кешированного файла.

## Задача: Обеспечить совместимость с Python 3.9 и уточнить установку codex-glibc
### Проблемы и blockers
- Код активно использовал объединяющие типы (`A | B`), которые требуют Python 3.10+, и минимальная версия в `pyproject.toml`/README оставалась 3.10.
- Установка `codex-glibc` могла останавливаться на шаге rustup без явного завершения.
### Решения и заметки
- Все аннотации типов переписаны на `Optional`/`Union`, чтобы код корректно работал на Python 3.9, и минимальная версия Python снижена до 3.9 в `pyproject.toml`, README и README-ru.
- В инсталляторе `codex-glibc` rustup запускается с `RUSTUP_INIT_SKIP_PATH_CHECK` и флагом `--no-modify-path`, добавлено явное сообщение о завершении установки rustup для удобства диагностики.

## Задача: Сохранять список inode в снимках резервного копирования
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- После создания снапшота добавлено формирование файла `.inodes` в корне резервной копии со списком файлов и их inode, отсортированных по относительным путям.

## Задача: Добавить автотесты для inode-манефеста бэкапа
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- В интеграционный тест бэкапа добавлена проверка содержимого `.inodes` и сортировки записей.

## Задача: Добавить диагностику и исправить установку агентов через Multipass
### Проблемы и blockers
- Команда установки агентов падала с сообщением "Too many arguments given" из-за вызова `multipass shell` с аргументами.
- При ошибках копирования/запуска скрипта установки не хватало подробных логов, чтобы быстро понять причину сбоя.
### Решения и заметки
- В установке агентов добавлены подробные логи выполняемых команд, stdout/stderr и результата очистки временного скрипта.
- Для запуска установочного скрипта используется `multipass exec`, который корректно принимает аргументы.

## Задача: Пробросить вывод установочного скрипта агентов в реальном времени
### Проблемы и blockers
- Во время установки агентов вывод bash-скрипта не отображался, потому что subprocess захватывал stdout/stderr.
### Решения и заметки
- Запуск установочного скрипта теперь выполняется без capture_output, чтобы Multipass передавал потоковый вывод на терминал.

## Задача: Переименовать команду остановки ВМ и добавить запуск
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Команда остановки ВМ переименована в `stop-vm`, добавлена новая команда `start-vm` с поддержкой выбора одной ВМ или всех сразу.
- Интерактивное меню, тесты и документация обновлены под новые команды.

## Задача: Расширить prepare для подготовки ВМ и SSH-ключей
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Команда `prepare` теперь устанавливает git и proxychains4 внутри ВМ, генерирует SSH-ключи в `~/.config/agsekit/ssh` при необходимости и добавляет их пользователю ubuntu.
- Повторный запуск проверяет установку пакетов и наличие ключей, выполняя недостающие шаги.

## Задача: Добавить логи и тесты для команды prepare
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Команда `prepare` теперь выводит дополнительные логи о создании и синхронизации SSH-ключей и установке пакетов.
- Добавлены тесты, проверяющие логи существующей пары ключей и выполнение шагов подготовки ВМ.

## Задача: Добавить команду agsekit ssh для подключения к ВМ
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Реализована команда `agsekit ssh`, которая подключается к Multipass ВМ по SSH с ключом `~/.config/agsekit/ssh/id_rsa` и прокидывает дополнительные аргументы ssh.
- Интерактивный режим и документация в README/README-ru обновлены, чтобы отражать новую команду.

## Задача: Добавить команду portforward для проброса портов по SSH
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Реализована команда `agsekit portforward`, запускающая отдельные `agsekit ssh` процессы для каждого набора правил `port-forwarding`, с перезапуском при завершении и корректным завершением по сигналам.
- Интерактивное меню и документация в README/README-ru обновлены, чтобы описать новую команду.

## Задача: Добавить команду systemd install для portforward
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлена команда `agsekit systemd install`, которая генерирует `~/.config/agsekit/systemd.env`, регистрирует user-юнит `systemd/agsekit-portforward.service` и запускает его через `systemctl --user`.
- В репозитории добавлен юнит systemd для запуска `agsekit portforward` с использованием переменных окружения.

## Задача: Добавить команду systemd uninstall для portforward
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлена команда `agsekit systemd uninstall`, которая останавливает и отключает user-юнит, затем удаляет ссылку на `systemd/agsekit-portforward.service` через `systemctl --user`.

## Задача: Добавить default-args для агентов и флаг пропуска
### Проблемы и blockers
- Нужно передавать параметры по умолчанию только если пользователь не переопределил их при запуске.
### Решения и заметки
- В конфигурацию агентов добавлен список `default-args`, а команда `run` получила флаг `--skip-default-args` для отключения этих параметров.

## Задача: Уточнить обработку default-args и исправить орфографию
### Проблемы и blockers
- Требовалось корректно обрабатывать варианты аргументов `--key value`, `--key` и `--key=value`, а также поправить опечатки в README.
### Решения и заметки
- Логика объединения default-args обновлена, добавлены тесты на разные варианты аргументов и исправлены найденные опечатки в README.

## Задача: Обновить версию и добавить changelog
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Версия в `pyproject.toml` обновлена до 0.9.0.
- Добавлен `changelog.md` с описанием первой полноценной версии и ключевого функционала.

## Задача: Добавить команду уничтожения ВМ и обновить документы
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлена команда `destroy-vm` с подтверждением удаления и флагом `-y` для массового или одиночного удаления ВМ.
- README и README-ru дополнены описанием новой команды; версия обновлена до 0.9.1 и изменения зафиксированы в `changelog.md`.
- В `AGENTS.md` закреплено правило, что запрос на увеличение версии подразумевает обновление `pyproject.toml` и `changelog.md`.

## Задача: Уточнить правила changelog и убрать упоминание README
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- В `changelog.md` оставлены только изменения функционала без упоминания README.
- В `AGENTS.md` добавлено правило фиксировать в changelog только функциональные изменения.

## Задача: Добавить слой i18n для CLI и локализацию сообщений
### Проблемы и blockers
- Требовалось собрать все пользовательские сообщения в одном месте и поддержать две локали без gettext.
### Решения и заметки
- Добавлен модуль i18n с загрузкой переводов из JSON по системной локали/AGSEKIT_LANG и fallback на английский.
- Все CLI-сообщения, ошибки конфигурации и логи бэкапов переведены на ключи, добавлены JSON-локали для русского и английского языков.
- Тесты стабилизированы установкой AGSEKIT_LANG по умолчанию и выбором русского в проверках русскоязычных сообщений.

## Задача: Добавить комментарии к неиспользуемым параметрам non_interactive
### Проблемы и blockers
- Нужно явно объяснить, почему non_interactive удаляется, чтобы избежать вопросов при ревью.
### Решения и заметки
- Добавлен комментарий рядом с каждым `del non_interactive`, поясняющий, что параметр не используется и удаляется для успокоения IDE/линтеров.

## Задача: Описать локализацию CLI в README
### Проблемы и blockers
- Требовалось кратко объяснить, как CLI выбирает язык и как переопределить локаль.
### Решения и заметки
- В README и README-ru добавлен раздел о локализации и переменной `AGSEKIT_LANG`.

## Задача: Обновить prepare для SSH-ключей и known_hosts
### Проблемы и blockers
- Команда prepare пыталась копировать приватный ключ в ВМ, вместо добавления публичного ключа в `authorized_keys` и заполнения `known_hosts` на хосте.
### Решения и заметки
- Логика подготовки ВМ оставляет приватный ключ на хосте, добавляет публичный ключ в `authorized_keys` и автоматически сохраняет ключи ВМ в `known_hosts` на хосте.

## Задача: Пробросить proxychains в установку агентов внутри ВМ
### Проблемы и blockers
- proxychains запускался на хосте, но установочные скрипты в ВМ вызывали `curl` и другие сетевые команды без прокси.
### Решения и заметки
- В установочные скрипты агентов добавлена поддержка переменной `AGSEKIT_PROXYCHAINS_PROXY` и запуск сетевых команд через proxychains4 при её наличии.
- Команда `install-agents` теперь прокидывает `AGSEKIT_PROXYCHAINS_PROXY` в ВМ при использовании proxychains.

## Задача: Исправить сборку codex-glibc при изменении структуры репозитория Codex
### Проблемы и blockers
- Установка codex-glibc падала с ошибкой отсутствия `Cargo.toml` в корне репозитория, потому что Rust-код переехал в подпапку.
### Решения и заметки
- Скрипт установки codex-glibc теперь ищет релевантный `Cargo.toml` для бинарника `codex`, логирует найденный manifest и использует `CARGO_TARGET_DIR` для предсказуемого пути к артефактам сборки.

## Задача: Закрепить кэш сборки codex-glibc и снизить потребление памяти
### Проблемы и blockers
- Сборка codex-glibc пересоздавала временную директорию и не переиспользовала `target`, а также упиралась в OOM на ВМ с 2 ГБ RAM.
### Решения и заметки
- Для сборки codex-glibc задан фиксированный `CARGO_TARGET_DIR` в `~/.tmp/build-codex-glibc` и включены настройки build-профиля с отключённым LTO и единичным job для снижения пикового потребления памяти.

## Задача: Добавить временный swap для сборки codex-glibc при нехватке RAM
### Проблемы и blockers
- Сборка codex-glibc может завершаться ошибкой при недостатке свободной RAM на ВМ.
### Решения и заметки
- Скрипт установки codex-glibc теперь проверяет доступную RAM с учётом буферов/кэша и Swap, создаёт временный swap-файл при нехватке памяти и удаляет его после сборки.

## Задача: Уточнить сообщения и очистку временного swap для codex-glibc
### Проблемы и blockers
- Требовалось выводить дополнительные сообщения о проверке RAM и корректно сохранять папку сборки при проблемах с запуском codex-glibc.
### Решения и заметки
- Добавлены сообщения о достаточности RAM, создание/удаление временного swap и проверка работоспособности codex-glibc перед удалением каталога сборки.

## Задача: Улучшить проверку наличия бинарника агента через Multipass exec
### Проблемы и blockers
- Проверка бинарника агента зависела от `multipass shell` и TTY, а также могла скрывать ошибки `multipass exec` под видом отсутствия бинарника.
### Решения и заметки
- Проверка переведена на `multipass exec` с явным добавлением стандартных путей в `PATH` для корректного обнаружения `codex-glibc`.
- При ошибках, отличных от отсутствия бинарника, сообщение об ошибке теперь включает stdout/stderr для диагностики.

## Задача: Перенести запуск proxychains внутрь VM при запуске агентов
### Проблемы и blockers
- Обёртка proxychains запускалась на хосте и формировала команду в обратном порядке, из-за чего прокси не применялся внутри ВМ.
### Решения и заметки
- Добавлено копирование `run_with_proxychains.sh` в `/tmp` внутри ВМ и запуск команд через него, чтобы proxychains применялся внутри гостя.
- Команды run и проверки бинарника агента теперь вызывают proxychains-обёртку внутри ВМ, а не на хосте.

## Задача: Запускать агента через multipass exec в foreground
### Проблемы и blockers
- Команда `agsekit run` использовала `multipass shell`, из-за чего агент не становился процессом в foreground и зависал, ожидая завершения подложенного shell.
### Решения и заметки
- Запуск агента переведён на `multipass exec`, а команда в госте запускается через `exec`, чтобы агент получал управление stdin/stdout/stderr напрямую.

## Задача: Отключить вывод proxychains при запуске agsekit run
### Проблемы и blockers
- При запуске `agsekit run` с proxychains диагностические сообщения proxychains засоряли stdout/stderr агента.
### Решения и заметки
- В proxychains-обёртке добавлен флаг `-q`, чтобы запуск через proxychains выполнялся без лишнего вывода.

## Задача: Обновить статус рабочих агентов, версию и changelog
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- В README и README-ru указаны актуальные рабочие агенты: qwen, codex и codex-glibc с динамической сборкой.
- Версия проекта поднята до 0.9.3, а в changelog отражены изменения по codex, codex-glibc и proxychains.

## Задача: Исправить список рабочих агентов по комментариям
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- В README и README-ru заменены формулировки на "типы агентов" и исправлен агент qwen.

## Задача: Убрать дублирующиеся блоки из README
### Проблемы и blockers
- В README и README-ru обнаружены повторяющиеся секции про бэкапы и интерактивный режим после YAML-примера.
### Решения и заметки
- Повторяющиеся блоки удалены, оставлены единые разделы в начале документации.

## Задача: Отредактировать формулировки в английском README
### Проблемы и blockers
- Обнаружены неестественные формулировки в описании работы агентов и конфигурации ВМ.
### Решения и заметки
- Исправлены формулировки на более естественные: agents run only inside a VM, multiple вместо several.

## Задача: Смягчить ошибку при повторном монтировании
### Проблемы и blockers
- Multipass возвращал ошибку, если папка уже была смонтирована, из-за чего `agsekit mount --all` завершался неуспехом.
### Решения и заметки
- Обработка монтирования распознаёт ответ "already mounted" и выводит сообщение об уже существующем монтировании вместо ошибки.

## Задача: Исправить соответствие host-addr/vm-addr для remote port-forwarding
### Проблемы и blockers
- Для `type: remote` аргументы SSH формировались в порядке host-addr → vm-addr, из-за чего адреса хоста и ВМ фактически менялись местами.
### Решения и заметки
- Обновлено формирование SSH-параметров, чтобы `remote` слушал на vm-addr и перенаправлял на host-addr.
- Примеры в README, README-ru и config-example.yaml приведены к новой трактовке.

## Задача: Добавить игнорирование loopback в proxychains конфиги
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- В шаблоны proxychains-конфигов для запуска и установки агентов добавлено localnet-правило для loopback.

## Задача: Вынести общий proxychains-хелпер для CLI и агентских скриптов
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлен общий скрипт proxychains_common.sh с функциями установки, генерации конфига и запуска команд через proxychains.
- Скрипты установки агентов и run_with_proxychains.sh переведены на использование общего хелпера; обновлён пакетный список данных для включения нового файла.

## Задача: Исправить запуск proxychains runner и проверку бинарников агента
### Проблемы и blockers
- Проверка бинарника агента могла ошибочно сообщать о его отсутствии при сбое proxychains-хелпера.
- Proxychains runner внутри ВМ не находил общий helper-скрипт после переноса в /tmp.
- NVM-обёртка применялась для всех агентов, даже если бинарник не требует Node.js.
### Решения и заметки
- Проверка наличия агента теперь показывает реальную ошибку при сбоях proxychains; отсутствие бинарника определяется отдельно.
- При подготовке proxychains runner в ВМ теперь копируется общий helper в /tmp/agent_scripts.
- NVM-инициализация применяется только для node-агентов (codex, qwen).

## Задача: Обновить версию и changelog для proxychains и ошибок запуска агента
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Версия проекта поднята до 0.9.4, изменения про proxychains и логирование ошибок запуска агента внесены в changelog.

## Задача: Настроить сборку и загрузку пакета в PyPI
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлен скрипт `build.sh` для сборки и загрузки пакета в PyPI/TestPyPI.
- В упаковку включён `config-example.yaml`, bash-скрипты и JSON-локали через `MANIFEST.in` и настройки setuptools.

## Задача: Добавить установку через pip и команду config-example
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- В README и README-ru добавлен вариант установки через `pip install agsekit` и команда `agsekit config-example` для копирования шаблона конфигурации.
- В CLI добавлена команда `config-example`, которая копирует пример конфигурации в указанный путь или дефолтную директорию.

## Задача: Разрешить команду config-example в интерактивном режиме
### Проблемы и blockers
- Команда `config-example` была недоступна в интерактивном режиме из-за отсутствия билдера.
### Решения и заметки
- Добавлен интерактивный обработчик для `config-example`, чтобы команда запускалась из TTY без ошибки.

## Задача: Увеличить версию и зафиксировать поддержку config-example в интерактивном режиме
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Версия проекта повышена на 0.0.1 и обновлён changelog с упоминанием интерактивной команды `config-example`.

## Задача: Сгруппировать команды интерактивного меню по секциям
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- В интерактивном меню команды сгруппированы с заголовками секций и исправленным названием `portforward`.

## Задача: Локализовать заголовки секций интерактивного меню
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Заголовки секций вынесены в ключи локализации для английского и русского языка.

## Задача: Обновить подписи секций и версию после изменения формата меню
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Обновлены русские подписи секций интерактивного меню и зафиксировано изменение формата меню в версии 0.9.6.

## Задача: Исправить установку агентов без proxychains_common внутри ВМ
### Проблемы и blockers
- Установочные скрипты агентов запускались без `proxychains_common.sh` внутри ВМ и падали при попытке загрузить helper.
### Решения и заметки
- Перед запуском установщика создаётся каталог `/tmp/agent_scripts` и в него копируется `proxychains_common.sh`, чтобы agent-скрипты могли подключить общий helper.

## Задача: Поднять версию и зафиксировать баг с proxychains при установке агентов
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Версия проекта повышена до 0.9.7 и в changelog отмечена правка установки агентов с proxychains.

## Задача: Убрать префикс ./ из предпросмотра команды в интерактивном режиме
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Предпросмотр команды запуска в интерактивном режиме теперь использует `agsekit` без префикса `./`.

## Задача: Обойти ошибку кодировки при записи снимка inode
### Проблемы и blockers
- В редких случаях запись файла `.inodes` падает с `UnicodeEncodeError`, когда путь содержит невалидные байты и суррогаты.
### Решения и заметки
- Запись файла `.inodes` переведена на `utf-8` с `errors="surrogateescape"`, чтобы безопасно сохранять такие пути без падения.

## Задача: Увеличить версию и отметить workaround для битого Unicode в бэкапах
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Версия проекта повышена до 0.9.8, а в changelog отмечен workaround для битых Unicode-имён при записи inode-снимков.

## Задача: Поддержать относительные пути для agsekit run внутри монтирования
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Команда run теперь принимает относительный путь и вычисляет путь внутри ВМ на основе ближайшего монтирования, сохраняя бэкапы на уровне всего маунта.

## Задача: Добавить тесты для относительных путей в agsekit run
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлен тест, проверяющий вычисление рабочей директории внутри ВМ для относительных путей и сохранение бэкапов на уровне маунта.

## Задача: Добавить локализацию для mounts.mounted
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- В локализации добавлены сообщения о успешном монтировании для mount-команды.

## Задача: Смягчить ошибки rsync с предупреждениями при бэкапах
### Проблемы и blockers
- При копировании системных директорий rsync может возвращать код 23/24 и прерывать запуск агента.
### Решения и заметки
- Ошибки rsync с кодами частичного переноса теперь логируются как предупреждения, бэкап продолжает выполнение, добавлены локализации и тест.

## Задача: Перенести подготовку ВМ из prepare в create-vm/create-vms
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Команда prepare теперь занимается установкой Multipass и генерацией SSH-ключей на хосте, без работы с ВМ.
- Команды create-vm/create-vms после создания (или при наличии) ВМ устанавливают нужные пакеты и синхронизируют SSH-ключи.

## Задача: Увеличить версию и отметить выравнивание поведения prepare/create-vm
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Версия повышена на 0.0.1, в changelog отмечено выравнивание поведения prepare и create-vm по их назначению.

## Задача: Добавить команду addmount для интерактивного добавления монтирований
### Проблемы и blockers
- Требовалось сохранять YAML-конфиг вместе с комментариями, поэтому понадобилась отдельная библиотека для round-trip записи.
### Решения и заметки
- Добавлена команда `agsekit addmount` с интерактивными подсказками по путям и интервалу, подтверждением и созданием резервной копии конфига перед записью.
- Для редактирования конфигурации используется ruamel.yaml, чтобы сохранить комментарии и форматирование YAML.
- Документация обновлена описанием новой команды.

## Задача: Дополнить addmount флагами -y и --mount и поправить порядок команд
### Проблемы и blockers
- Требовалось обеспечить обязательное подтверждение при добавлении маунта без -y и дать возможность сразу смонтировать запись.
### Решения и заметки
- В addmount добавлены подтверждение с выводом параметров, флаг -y для пропуска, опция --mount и интерактивный вопрос о немедленном монтировании.
- Команда addmount перенесена в конец списка команд монтирования в README и интерактивном меню.
