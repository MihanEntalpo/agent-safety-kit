# Журнал задач и решений

## Задача: Подготовить рабочую структуру проекта для агентного запуска в Multipass
### Проблемы и blockers
- Блокирующих проблем по задаче не выявлено.
### Решения и заметки
- Описана стартовая структура проекта и связи с мультипасс-окружением.

## Задача: Задокументировать правила ведения workflow и общие инструкции
### Проблемы и blockers
- Блокирующих проблем по задаче не выявлено.
### Решения и заметки
- Добавлен файл `AGENTS.md` с требованиями к ведению этого журнала.
- Созданы симлинки `QWEN.md` и `CLAUDE.md`, указывающие на единый набор инструкций.
- Планируется дополнять журнал по мере появления новых задач и опыта.

## Задача: Настроить базовые скрипты установки Multipass и создания ВМ на основе конфигурации
### Проблемы и blockers
- Изменение параметров уже созданной ВМ пока не поддерживается и требует отдельной проработки.
### Решения и заметки
- Реализованы скрипты `install_multipass.sh` и `create_vm.sh`, пример конфигурации `example.env`, а также инструкции по использованию в `README.md`.
- Добавлена проверка конфигурации существующей ВМ с указанием несовпадающих параметров.

## Задача: Учесть комментарии по скриптам Multipass и документации
### Проблемы и blockers
- Блокирующих проблем по задаче не выявлено.
### Решения и заметки
- Вынесена функция загрузки переменных окружения в `lib/utils.sh` и подключена в `create_vm.sh`.
- Уточнены инструкции по работе со скриптами в `README.md`, включая сообщение о конкретных отличиях ресурсов при существующей ВМ.

## Задача: Добавить утилиту однократного резервного копирования
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Создан скрипт `libs/make_single_backup.sh` на Python, выполняющий копирование через `rsync`, поддерживающий инкременты через `--link-dest`, исключения из `.backupignore` и аргументов `--exclude`, а также финальное переименование каталога с временным суффиксом.
- README дополнен описанием внутренних утилитарных скриптов и новой утилиты.

## Задача: Добавить интеграционный тест для скрипта резервного копирования
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Написан интеграционный тест `tests/test_make_single_backup.py`, покрывающий сценарии исключений `.backupignore`, аргументы `--exclude`, очистку каталогов `-inprogress` и инкрементальные копии с hardlink'ами.

## Задача: Уточнить поведение инкрементального бэкапа и его тестов
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Скрипт резервного копирования создаёт временные каталоги с суффиксом `-partial` и удаляет их при перезапусках.
- Интеграционные тесты дополнены проверкой очистки незавершённых запусков и валидацией, что неизменённые файлы сохраняют один и тот же inode между снапшотами.

## Задача: Пропускать создание бэкапа при отсутствии изменений
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Перед копированием выполняется `rsync --dry-run` с анализом изменений; при их отсутствии выводится сообщение и новый снапшот не создаётся.
- Интеграционный тест проверяет, что повторный запуск без изменений не создаёт новую папку и оставляет директорию `dest` без `-partial` следов.

## Задача: Проверить поддержку всех основных паттернов `.backupignore`
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлен интеграционный тест, создающий временные структуры с вложенными `.backupignore`, масками, исключёнными директориями, якорными правилами и переопределениями через `!`.
- README дополнен разделом «Резервное копирование» и примерами паттернов для `.backupignore`.

## Задача: Покрыть несколькими вложенными `.backupignore`
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлен интеграционный тест, который создаёт и проверяет каскад из нескольких вложенных `.backupignore` (три уровня вложенности) и их комбинированные правила исключений/включений для файлов и директорий.

## Задача: Добавить логи и обработку ошибок в скрипт резервного копирования
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Скрипт бэкапа выводит явные логи очистки незавершённых снапшотов, запуска `rsync` и итогового создания каталога снапшота.
- Ошибки выводятся в stderr, завершаясь ненулевым кодом возврата; интеграционные тесты покрывают новые сообщения и поведение ошибок.

## Задача: Перейти на единую Python CLI с YAML-конфигурацией
### Проблемы и blockers
- Требовалось заменить bash-скрипты и env-конфигурацию на более расширяемый формат и общую точку входа.
### Решения и заметки
- Добавлен пример `config-example.yaml` и загрузчик конфигурации из YAML (путь можно задать через `CONFIG_PATH`).
- Создан Python-CLI `./agsekit` на базе `click` с командами `prepare`, `create-vm` и `backup-once` (резервное копирование перенесено в CLI).
- Bash-скрипты и `.env`-пример удалены; инструкции в README обновлены, добавлены зависимости в `requirements.txt` и шаги по созданию virtualenv.

## Задача: Учесть комментарии к README и примеру конфигурации
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- README дополнен шагом клонирования репозитория, комментариями и подсказками по умолчаниям `target`/`backup` в разделе YAML.
- Пример конфигурации `config-example.yaml` снабжён поясняющими комментариями по каждому полю.
- Примеры `.backupignore` оформлены единым блоком с комментариями внутри.

## Задача: Разделить README на русскую и английскую версии
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Русская документация перенесена в `README-ru.md`, добавлена кросс-ссылка на английскую версию.
- Создан английский `README.md` с эквивалентным содержанием и ссылкой на русскую версию.
- В `AGENTS.md` зафиксировано правило держать обе версии README в актуальном состоянии при правках.
- Комментарий в примере `config-example.yaml` обновлён с учётом переименованных README.

## Задача: Добавить циклическое резервное копирование и интервалы в конфиге
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлен Python-модуль циклических бэкапов с немедленным стартом, сообщением `Done, waiting N minutes` и проверкой положительного интервала.
- Конфигурация `mounts` поддерживает поле `interval` с умолчанием 5 минут, снабжена валидацией и примером в `config-example.yaml`.
- В CLI появились команды `backup-repeated`, `backup-repeated-mount` и `backup-repeated-all`; README/README-ru дополнены описанием новых параметров и команд.

## Задача: Уточнить документацию циклических бэкапов и покрыть новые команды тестами
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Скорректированы комментарии в README, подчёркивающие интервалы по умолчанию и способы указания пути к конфигу.
- Зафиксировано правило добавлять новые задачи в конец `workflow.md`.
- Добавлены автотесты для CLI-команд циклического бэкапа, покрывающие поиск монтирования, ошибки отсутствующих записей и запуск параллельных циклов.

## Задача: Добавить поддержку нескольких ВМ и проверку ресурсов перед созданием
### Проблемы и blockers
- Требовалось пересобрать конфигурацию под несколько ВМ и учесть ограничения ресурсов хоста.
### Решения и заметки
- Конфиг переведён на раздел `vms` с параметрами нескольких машин и привязкой монтирований к конкретной ВМ.
- CLI получил команды `create-vm <имя>` и `create-vms`, перед созданием выполняется проверка, что после выделения ресурсов останется минимум 1 CPU и 1 ГБ RAM.
- Добавлены валидации для настроек монтирований и примеры/документация обновлены в обоих README и `config-example.yaml`.

## Задача: Добавить команды mount и umount для управления монтированиями
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- CLI пополнен командами `mount` и `umount`, которые принимают путь `--source-dir` или флаг `--all` и читают настройки монтирований из YAML-конфигурации (`config.yaml`, `CONFIG_PATH` или `--config`).
- Реализована общая логика загрузки монтирований и вызовов `multipass mount/umount`, покрытая интеграционными тестами для CLI.
- Документация на русском и английском дополнена описанием новых команд.

## Задача: Добавить шаг монтирования в инструкцию быстрого старта
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- В разделах Quick start/Быстрый старт README добавлен пункт о запуске `./agsekit mount --all` для монтирования заранее настроенных папок.

## Задача: Добавить конфигурацию и команды для работы с агентами
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- Конфигурация YAML расширена секцией `agents` с типами qwen/codex/claude, прокси и переменными окружения.
- Добавлены команды CLI `setup-agents` для установки агентов в ВМ и `run` для запуска агента с прокси, переменными окружения и фоновыми бэкапами.
- README и README-ru дополнены описанием новых опций и примерами использования.

## Задача: Уточнить комментарии к установке и запуску агентов
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- Уточнены комментарии по типам агентов и прокси в примере YAML и README.
- Обновлены скрипты установки агентов для codex-cli, qwen-code и claude-code реальными командами.
- В quickstart добавлен шаг установки всех агентов в их ВМ по умолчанию.

## Задача: Убрать упоминание прокси из описания команды run
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- Описание `./agsekit run` в README и README-ru приведено в соответствие текущей реализации без упоминания прокси.

## Задача: Добавить англоязычные сообщения CLI и уточнить установку агентов
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Команды CLI выводят поясняющие сообщения перед выполнением действий (установка зависимостей, создание ВМ, монтирование, бэкапы, запуск агентов) и логируют фоновые бэкапы.
- Добавлена проверка наличия бинарника агента в выбранной ВМ с понятной подсказкой о необходимости `setup-agents`.
- Скрипт установки qwen-code устанавливает Node.js/npm через apt при отсутствии и сообщает об ошибке, если npm всё ещё недоступен.
- README и README-ru синхронизированы: обновлены команды клонирования и virtualenv, добавлены шаги про циклические бэкапы и пример запуска агента в быстром старте.

## Задача: Уточнить установку qwen-code через nvm
### Проблемы и blockers
- Требовалось установить Node.js корректной версией без зависимости от системных пакетов.
### Решения и заметки
- Скрипт установки qwen-code ставит nvm при отсутствии Node.js, загружает его окружение и устанавливает Node.js 24 с выводом версий.
- При отсутствии npm после установки выводится понятная ошибка о необходимости ручной установки Node.js/nvm.

## Задача: Пропускать подготовку, если Multipass уже установлен
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Команда `prepare` проверяет наличие Multipass и при установленном бинарнике пропускает шаги `apt-get` и установки.

## Задача: Искать корректный бинарник Qwen при запуске агента
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Тип агента qwen теперь приводит к вызову бинарника `qwen` (ранее искали `qwen-code`), обновлены примеры конфигурации и тесты.

## Задача: Поправить комментарии к типу агента qwen-code
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- Примеры конфигурации в README и config-example.yaml оставляют тип `qwen-code`, уточняя, что используется бинарник `qwen`.

## Задача: Добавить интерактивный режим запуска CLI
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- Добавлен интерактивный режим, который запускается в TTY при отсутствии или нехватке аргументов и предлагает выбрать команду и параметры из конфигурации.
- Расширен requirements новым зависимым пакетом `questionary` для отображения списков выбора и подтверждений.

## Задача: Покрыть интерактивный режим тестами
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлены pytest-тесты, проверяющие запуск интерактивного режима при отсутствии аргументов или нехватке параметров и сохранение стандартного вывода помощи в неинтерактивной среде.
- Покрыт сценарий успешного выполнения интерактивного вызова команды без выхода из процесса.

## Задача: Добавить флаг принудительно неинтерактивного режима
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- Во все команды CLI добавлен параметр `--non-interactive`, который отключает автоматический запуск интерактивного режима.
- Основной вход CLI учитывает флаг, избегая перехода в интерактивный режим даже в TTY при нехватке аргументов.
- Добавлены тесты, проверяющие отсутствие интерактивного режима при использовании нового флага.

## Задача: Уточнить порядок выбора ВМ при установке агента
### Проблемы и blockers
- Блокирующих проблем не возникло.
### Решения и заметки
- В интерактивном режиме при установке агента сначала предлагается ВМ по умолчанию с указанием её имени, затем список доступных ВМ и опция выбора всех ВМ.

## Задача: Исправить выбор ВМ по умолчанию при установке агентов
### Проблемы и blockers
- В интерактивном режиме выбор варианта "Использовать ВМ по умолчанию" передавался как позиционный аргумент, что конфликтовало с флагом `--all-agents` и вызывало ошибку CLI.
### Решения и заметки
- Опция выбора ВМ по умолчанию получила отдельное значение, исключающее добавление позиционного аргумента в команду `setup-agents`.

## Задача: Уточнить окружение для qwen, .gitignore и версию Python
### Проблемы и blockers
- Бинарник qwen устанавливается через nvm и не попадал в PATH при запуске агента, из-за чего CLI не находил `qwen` внутри ВМ.
- Несколько пользовательских файлов (`.python-version`, `config.yaml`, `venv/` и кэши) не игнорировались git'ом.
- В README отсутствовало требование к минимальной версии Python.
### Решения и заметки
- Команды запуска агента теперь предварительно загружают окружение nvm, чтобы `qwen` был доступен в PATH внутри ВМ.
- `.gitignore` дополнен путями к локальному окружению и файлам конфигурации.
- В обоих README указана минимальная поддерживаемая версия Python (3.10+).

## Задача: Добавить qwen в PATH при установке
### Проблемы и blockers
- После установки через nvm бинарник `qwen` оказывался вне стандартного PATH при неинтерактивном запуске.
### Решения и заметки
- Скрипт установки qwen создаёт ссылку на глобальный бинарник в доступном каталоге (`/usr/local/bin` либо `~/.local/bin`) и при необходимости добавляет `~/.local/bin` в PATH через `~/.profile`.

## Задача: Исправить установку qwen при отсутствии команды `npm bin`
### Проблемы и blockers
- Установка агента прерывалась на npm 11 из-за отсутствия команды `npm bin`, используемой для поиска каталога глобальных бинарников.
### Решения и заметки
- Скрипт установки qwen определяет путь глобальных бинарников через `npm prefix -g` и завершается с понятной ошибкой, если префикс недоступен.

## Задача: Перенаправить логи бэкапов и запускать агента из рабочей директории
### Проблемы и blockers
- Логи фоновых бэкапов выводились в stdout процесса, что мешало основному выводу агента.
- Запуск агента в ВМ требовал гарантированного перехода в рабочую директорию, чтобы не передавать путь проектной папки в качестве аргумента.
### Решения и заметки
- Фоновые процессы резервного копирования пишут stdout/stderr в файл `backup.log` в каталоге бэкапов, создавая директорию при необходимости и закрывая лог при завершении.
- Команда `run` выполняет агент внутри Multipass c явным `--workdir` и сменой каталога перед запуском бинарника агента.

## Задача: Исправить передачу ВМ по умолчанию в интерактивном режиме запуска
### Проблемы и blockers
- При выборе опции "Определить автоматически" интерактивный режим передавал её как явное имя ВМ, что ломало поиск монтирования.
### Решения и заметки
- Значение авто-выбора теперь заменяется на служебный код и не передаётся как аргумент `--vm`.
- Добавлен тест, который проверяет сбор аргументов `run` без явного флага `--vm` при авто-выборе.

## Задача: Убрать несовместимый флаг `--workdir` из команды запуска агента
### Проблемы и blockers
- В текущей версии Multipass опция `--workdir` для `multipass exec` не поддерживается, из-за чего запуск агента падал с ошибкой "Unknown option 'workdir'".
### Решения и заметки
- Аргумент `--workdir` убран из вызова `multipass exec`, при этом переход в рабочую директорию сохраняется через команду `cd` внутри запускаемого шелла.
- Добавлен тест, гарантирующий отсутствие флага `--workdir` и сохранение перехода в каталог при формировании команды.

## Задача: Добавить флаг `--debug` для вывода исполняемых команд при запуске агента
### Проблемы и blockers
- Пользователь не видел, какие внешние команды вызываются при запуске агента, из-за чего сложно понимать причину сбоев.
### Решения и заметки
- Во все вызовы Multipass и фоновых бэкапов, инициируемых командой `run`, добавлен опциональный вывод запускаемых команд.
- Команда `run` принимает флаг `--debug`, передавая его в проверки наличия бинарника агента, запуск фонового бэкапа и основной вызов агента внутри ВМ.
- Документация в README и README-ru дополнена описанием нового флага.
