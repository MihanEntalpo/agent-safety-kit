# Журнал задач и решений

## Задача: Подготовить рабочую структуру проекта для агентного запуска в Multipass
### Проблемы и blockers
- Блокирующих проблем по задаче не выявлено.
### Решения и заметки
- Описана стартовая структура проекта и связи с мультипасс-окружением.

## Задача: Задокументировать правила ведения workflow и общие инструкции
### Проблемы и blockers
- Блокирующих проблем по задаче не выявлено.
### Решения и заметки
- Добавлен файл `AGENTS.md` с требованиями к ведению этого журнала.
- Созданы симлинки `QWEN.md` и `CLAUDE.md`, указывающие на единый набор инструкций.
- Планируется дополнять журнал по мере появления новых задач и опыта.

## Задача: Настроить базовые скрипты установки Multipass и создания ВМ на основе конфигурации
### Проблемы и blockers
- Изменение параметров уже созданной ВМ пока не поддерживается и требует отдельной проработки.
### Решения и заметки
- Реализованы скрипты `install_multipass.sh` и `create_vm.sh`, пример конфигурации `example.env`, а также инструкции по использованию в `README.md`.
- Добавлена проверка конфигурации существующей ВМ с указанием несовпадающих параметров.

## Задача: Учесть комментарии по скриптам Multipass и документации
### Проблемы и blockers
- Блокирующих проблем по задаче не выявлено.
### Решения и заметки
- Вынесена функция загрузки переменных окружения в `lib/utils.sh` и подключена в `create_vm.sh`.
- Уточнены инструкции по работе со скриптами в `README.md`, включая сообщение о конкретных отличиях ресурсов при существующей ВМ.

## Задача: Добавить утилиту однократного резервного копирования
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Создан скрипт `libs/make_single_backup.sh` на Python, выполняющий копирование через `rsync`, поддерживающий инкременты через `--link-dest`, исключения из `.backupignore` и аргументов `--exclude`, а также финальное переименование каталога с временным суффиксом.
- README дополнен описанием внутренних утилитарных скриптов и новой утилиты.

## Задача: Добавить интеграционный тест для скрипта резервного копирования
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Написан интеграционный тест `tests/test_make_single_backup.py`, покрывающий сценарии исключений `.backupignore`, аргументы `--exclude`, очистку каталогов `-inprogress` и инкрементальные копии с hardlink'ами.

## Задача: Уточнить поведение инкрементального бэкапа и его тестов
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Скрипт резервного копирования создаёт временные каталоги с суффиксом `-partial` и удаляет их при перезапусках.
- Интеграционные тесты дополнены проверкой очистки незавершённых запусков и валидацией, что неизменённые файлы сохраняют один и тот же inode между снапшотами.

## Задача: Пропускать создание бэкапа при отсутствии изменений
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Перед копированием выполняется `rsync --dry-run` с анализом изменений; при их отсутствии выводится сообщение и новый снапшот не создаётся.
- Интеграционный тест проверяет, что повторный запуск без изменений не создаёт новую папку и оставляет директорию `dest` без `-partial` следов.

## Задача: Проверить поддержку всех основных паттернов `.backupignore`
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлен интеграционный тест, создающий временные структуры с вложенными `.backupignore`, масками, исключёнными директориями, якорными правилами и переопределениями через `!`.
- README дополнен разделом «Резервное копирование» и примерами паттернов для `.backupignore`.

## Задача: Покрыть несколькими вложенными `.backupignore`
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлен интеграционный тест, который создаёт и проверяет каскад из нескольких вложенных `.backupignore` (три уровня вложенности) и их комбинированные правила исключений/включений для файлов и директорий.

## Задача: Добавить логи и обработку ошибок в скрипт резервного копирования
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Скрипт бэкапа выводит явные логи очистки незавершённых снапшотов, запуска `rsync` и итогового создания каталога снапшота.
- Ошибки выводятся в stderr, завершаясь ненулевым кодом возврата; интеграционные тесты покрывают новые сообщения и поведение ошибок.

## Задача: Перейти на единую Python CLI с YAML-конфигурацией
### Проблемы и blockers
- Требовалось заменить bash-скрипты и env-конфигурацию на более расширяемый формат и общую точку входа.
### Решения и заметки
- Добавлен пример `config-example.yaml` и загрузчик конфигурации из YAML (путь можно задать через `CONFIG_PATH`).
- Создан Python-CLI `./agsekit` на базе `click` с командами `prepare`, `create-vm` и `backup-once` (резервное копирование перенесено в CLI).
- Bash-скрипты и `.env`-пример удалены; инструкции в README обновлены, добавлены зависимости в `requirements.txt` и шаги по созданию virtualenv.

## Задача: Учесть комментарии к README и примеру конфигурации
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- README дополнен шагом клонирования репозитория, комментариями и подсказками по умолчаниям `target`/`backup` в разделе YAML.
- Пример конфигурации `config-example.yaml` снабжён поясняющими комментариями по каждому полю.
- Примеры `.backupignore` оформлены единым блоком с комментариями внутри.

## Задача: Разделить README на русскую и английскую версии
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Русская документация перенесена в `README-ru.md`, добавлена кросс-ссылка на английскую версию.
- Создан английский `README.md` с эквивалентным содержанием и ссылкой на русскую версию.
- В `AGENTS.md` зафиксировано правило держать обе версии README в актуальном состоянии при правках.
- Комментарий в примере `config-example.yaml` обновлён с учётом переименованных README.

## Задача: Добавить циклическое резервное копирование и интервалы в конфиге
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Добавлен Python-модуль циклических бэкапов с немедленным стартом, сообщением `Done, waiting N minutes` и проверкой положительного интервала.
- Конфигурация `mounts` поддерживает поле `interval` с умолчанием 5 минут, снабжена валидацией и примером в `config-example.yaml`.
- В CLI появились команды `backup-repeated`, `backup-repeated-mount` и `backup-repeated-all`; README/README-ru дополнены описанием новых параметров и команд.

## Задача: Уточнить документацию циклических бэкапов и покрыть новые команды тестами
### Проблемы и blockers
- Блокирующих проблем не выявлено.
### Решения и заметки
- Скорректированы комментарии в README, подчёркивающие интервалы по умолчанию и способы указания пути к конфигу.
- Зафиксировано правило добавлять новые задачи в конец `workflow.md`.
- Добавлены автотесты для CLI-команд циклического бэкапа, покрывающие поиск монтирования, ошибки отсутствующих записей и запуск параллельных циклов.

## Задача: Добавить поддержку нескольких ВМ и проверку ресурсов перед созданием
### Проблемы и blockers
- Требовалось пересобрать конфигурацию под несколько ВМ и учесть ограничения ресурсов хоста.
### Решения и заметки
- Конфиг переведён на раздел `vms` с параметрами нескольких машин и привязкой монтирований к конкретной ВМ.
- CLI получил команды `create-vm <имя>` и `create-vms`, перед созданием выполняется проверка, что после выделения ресурсов останется минимум 1 CPU и 1 ГБ RAM.
- Добавлены валидации для настроек монтирований и примеры/документация обновлены в обоих README и `config-example.yaml`.
