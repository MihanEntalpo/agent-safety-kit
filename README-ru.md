[English README](README.md)
[Философия проекта](philosophy-ru.md) | [Project Philosophy](philosophy.md)

# Agent Safety Kit

Набор инструментов для запуска AI-агентов в изолированной среде внутри виртуальной машины Multipass.

## Немного ликбеза, если вы не понимаете зачем это:

<img width="437" height="379" alt="image" src="https://github.com/user-attachments/assets/c3486072-e96a-4197-8b1f-d6ac228c2cc6" />

Немного ссылок (нагуглить такого можно море):

* [Qwen Coder agent destroys working builds](https://github.com/QwenLM/qwen-code/issues/354)
* [Codex keeps deleting unrelated and uncommitted files! even ignoring rejected requests](https://github.com/openai/codex/issues/4969)
* [comment: qwen-code CLI destroyed my entire project, deleted important files](https://www.reddit.com/r/DeepSeek/comments/1mmfjsl/right_now_qwen_is_the_best_model_they_have_the/)
* [Claude Code deleted my entire workspace, here's the proof](https://www.reddit.com/r/ClaudeAI/comments/1m299f5/claude_code_deleted_my_entire_workspace_heres_the/)
* [I Asked Claude Code to Fix All Bugs, and It Deleted the Whole Repo](https://levelup.gitconnected.com/i-asked-claude-code-to-fix-all-bugs-and-it-deleted-the-whole-repo-e7f24f5390c5)
* [Codex has twice deleted and corrupted my files (r/ClaudeAI comment)](https://www.reddit.com/r/ClaudeAI/comments/1nhvyu0/openai_drops_gpt5_codex_cli_right_after/)

Понятно, что "все понимают" и "у всех должны быть бэкапы" и "у вас всё должно быть в git", но пока "песочница" которую предоставляют консольные ИИ-агенты не имеет встроенных снапшотов, позволяющих откатываться назад после каждой правки, сделанной ИИ, нужен некий инструмент, который позволит сделать это самостоятельно.

## Ключевые идеи

- Агент работает только в виртуальной машине.
- Виртуальная машина запускается через Multipass (это простой инструмент от Canonical для запуска ubuntu в виртуалке в 1 команду)
- Внутрь ВМ монтируются проектные папки из указанной пользователем директории; параллельно запускается автоматическое резервное копирование в соседнюю папку с настраиваемой частотой (по умолчанию раз в пять минут и только при изменениях), использующее `rsync` и hardlink'и для экономии места.
- Настройки виртуальной машины, монтирования и cloud-init задаются в YAML-конфиге.
- Агент можно запускать, не входя в гостевую систему через `multipass shell` — фактически он всё равно исполняется внутри ВМ.
- Команды Multipass и запуски агента можно оборачивать в proxychains: укажите URL прокси для ВМ или временно переопределите его флагом `--proxychains`, CLI автоматически создаст временный конфиг proxychains.

## Рабочие агенты

Сейчас подтверждённо работают такие типы агентов:

- qwen
- codex
- claude
- codex-glibc (собирается динамически)

## Быстрый старт

1. Установите пакет через pip (требуется Python 3.9 или новее):
   ```bash
   python3 -m venv ./venv
   source ./venv/bin/activate
   pip install agsekit
   ```
   Так команда `agsekit` станет доступна внутри виртуального окружения.

2. Либо можно склонировать репозиторий и установить из исходников:
   ```bash
   git clone https://github.com/MihanEntalpo/agent-safety-kit/
   cd agent-safety-kit
   pip install .
   ```

3. Создайте YAML-конфигурацию (CLI ищет путь в `--config`, затем в `CONFIG_PATH`, затем в `~/.config/agsekit/config.yaml`):
   ```bash
   agsekit config-example
   # отредактируйте параметры vms/mounts/cloud-init под себя
   ```
   При работе из клонированного репозитория можно скопировать файл напрямую:
   ```bash
   mkdir -p ~/.config/agsekit
   cp config-example.yaml ~/.config/agsekit/config.yaml
   ```
   Можно также запустить `agsekit config-gen`, чтобы ответить на вопросы и сохранить конфиг (по умолчанию в `~/.config/agsekit/config.yaml`; чтобы перезаписать существующий файл, добавьте `--overwrite`).

4. Установите необходимые системные зависимости (в частности, Multipass; потребуется sudo, работает пока только в debian-based системах). Команда также создаёт SSH-ключи на хосте для доступа к ВМ:
   ```bash
   agsekit prepare
   ```

5. Создайте виртуальные машины с параметрами из YAML (заодно устанавливаются пакеты через ansible и синхронизируются SSH-ключи):
   ```bash
   agsekit create-vms
   ```

   Если нужно развернуть только одну ВМ, используйте `agsekit create-vm <имя>`. Когда в конфиге описана единственная ВМ, имя можно не указывать — она будет выбрана автоматически. Если ВМ уже существует, команда сравнит заданные ресурсы с текущими и сообщит об отличающихся параметрах. Пока изменить параметры уже работающей машины нельзя

6. Смонтируйте папки (предполагается, что монтирования уже описаны в YAML):
   ```bash
   agsekit mount --all
   ```

7. Установите все описанные агенты в их ВМ по умолчанию:
   ```bash
   agsekit install-agents --all-agents
   ```

8. Запустите агента внутри его ВМ (пример запускает `qwen` в папке, куда смонтирована `/host/path/project`, бэкапы включены по умолчанию):
   ```bash
   agsekit run qwen /host/path/project --vm agent-ubuntu
   ```
   При первом запуске с включёнными бэкапами утилита сначала сделает первичную копию с прогресс-баром, поэтому дождитесь её завершения перед стартом агента.

## Команды agsekit

### Подготовка и жизненный цикл ВМ

Большинство команд, взаимодействующих с Multipass, поддерживают `--debug`; в этом режиме CLI выводит запускаемую команду, код завершения и захваченные `stdout`/`stderr`.

* `agsekit prepare` — устанавливает системные зависимости (включая Multipass; требует sudo и работает пока только в debian-based системах) и создаёт SSH-ключи для доступа к ВМ.
* `agsekit config-gen [--config <path>] [--overwrite]` — интерактивный мастер, который задаёт вопросы про ВМ, монтирования и агентов и записывает YAML-конфиг в выбранный путь (по умолчанию `~/.config/agsekit/config.yaml`). Без флага `--overwrite` команда предупредит о существующем файле.
* `agsekit config-example [<path>]` — копирует `config-example.yaml` в указанный путь (по умолчанию `~/.config/agsekit/config.yaml`). Если конфиг уже существует, копирование по умолчанию пропускается.
* `agsekit pip-upgrade` — обновляет agsekit через `pip install agsekit --upgrade` в том же Python-окружении, где запущена CLI. Если agsekit не установлен в этом окружении через pip, команда сообщает, что обновление невозможно.
* `agsekit version` — выводит установленную версию пакета и версию проекта из `pyproject.toml`, если файл доступен.
* `agsekit status [--config <path>] [--debug]` — выводит сводный отчёт по ВМ из конфига: путь к конфигу, состояние ВМ (запущена/остановлена), ресурсы из конфига и фактические, правила проброса портов и статус процесса `agsekit portforward`, таблицу монтирований и бэкапов (включая время последнего снапшота и эвристику «бэкапы запущены?»), список настроенных/установленных агентов и список запущенных процессов агентов в каждой ВМ (PID, бинарник, имена из конфига и рабочая директория процесса).
* `agsekit create-vms [--debug]` — создаёт все ВМ, указанные в YAML-конфигурации, и подготавливает их (устанавливает пакеты через ansible и синхронизирует SSH-ключи).
* `agsekit create-vm <name> [--debug]` — запускает только одну ВМ и подготавливает её (устанавливает пакеты через ansible и синхронизирует SSH-ключи). Если в конфиге указана единственная ВМ, имя можно не передавать — она выберется автоматически. Если ВМ уже существует, команда сравнит желаемые ресурсы с текущими и сообщит об отличиях. Изменять ресурсы уже созданной ВМ пока нельзя.
* `agsekit shell [<vm_name>] [--config <path>] [--debug]` — открывает интерактивную сессию `multipass shell` внутри выбранной ВМ и применяет настроенный проброс портов. Если в конфиге только одна ВМ, CLI подключится к ней даже без `vm_name`. Когда ВМ несколько и команда выполняется в TTY, CLI предложит выбрать нужную; в неинтерактивном режиме имя ВМ обязательно.
* `agsekit ssh <vm_name> [--config <path>] [--debug] [<ssh_args...>]` — подключается к ВМ по SSH с ключом `~/.config/agsekit/ssh/id_rsa` и передаёт любые дополнительные аргументы напрямую в `ssh` (например `-L`, `-R`, `-N`).
* `agsekit portforward [--config <path>] [--debug]` — запускает отдельный `agsekit ssh`-туннель для каждой ВМ с правилами `port-forwarding`, следит за процессами и перезапускает их при завершении. Остановку выполняйте через Ctrl+C для корректного завершения туннелей.
* `agsekit start-vm <vm_name> [--config <path>] [--debug]` — запускает выбранную ВМ из конфигурации. Если в конфиге только одна ВМ, имя можно опустить.
* `agsekit start-vm --all-vms [--config <path>] [--debug]` — запускает все ВМ, описанные в конфиге.
* `agsekit stop-vm <vm_name> [--config <path>] [--debug]` — останавливает выбранную ВМ из конфигурации. Если в конфиге только одна ВМ, имя можно опустить.
* `agsekit stop-vm --all-vms [--config <path>] [--debug]` — останавливает все ВМ, описанные в конфиге.
* `agsekit destroy-vm <vm_name> [--config <path>] [-y] [--debug]` — удаляет указанную ВМ из Multipass. Без `-y` команда запрашивает интерактивное подтверждение.
* `agsekit destroy-vm --all [--config <path>] [-y] [--debug]` — удаляет все ВМ из конфигурации с таким же подтверждением.
* `agsekit systemd install [--config <path>]` — записывает `~/.config/agsekit/systemd.env` с абсолютными путями к `agsekit`, конфигу и текущему каталогу проекта, затем регистрирует и запускает user-юнит из `systemd/agsekit-portforward.service` через `systemctl --user` (link, daemon-reload, start, enable).
* `agsekit systemd uninstall` — останавливает и отключает user-юнит, затем удаляет ссылку на `systemd/agsekit-portforward.service` из systemd через `systemctl --user`.

### Управление монтированием

* `agsekit mount --source-dir <path> [--config <path>] [--debug]` — монтирует директорию с `source`, описанную в конфиге (путь ищется в `--config`, `CONFIG_PATH`, `~/.config/agsekit/config.yaml`), в соответствующую ВМ через `multipass mount`. Флаг `--all` монтирует все записи из конфига. Когда в конфиге только одно монтирование, команду можно вызывать без `--source-dir` или `--all`.
* `agsekit umount --source-dir <path> [--config <path>] [--debug]` — размонтирует директорию `source` из конфига (или `CONFIG_PATH`/`--config`); `--all` размонтирует все указанные пути. Если монтирование единственное, флаги можно не указывать.
* `agsekit addmount <путь> [<путь_внутри_VM> <путь_бэкапов> <интервал>] [--max-backups <число>] [--backup-clean-method <tail|thin>] [--config <путь>] [--mount] [-y] [--debug]` — добавляет монтирование в YAML-конфиг (путь ищется в `--config`, `CONFIG_PATH`, `~/.config/agsekit/config.yaml`). Если `<путь>` не указан, команда запускает интерактивный режим и предлагает выбрать путь на хосте. Путь внутри ВМ по умолчанию `/home/ubuntu/<имя_папки>`, путь для бэкапов — `<родитель>/backups-<имя_папки>`, интервал — пять минут, лимит хранения — 100 снапшотов, метод очистки — `thin`. Перед сохранением CLI выводит параметры и запрашивает подтверждение, если не указан `-y`; также создаётся резервная копия конфига с временной меткой и сохраняются комментарии. Флаг `--mount` сразу монтирует новую запись (в интерактивном режиме дополнительно спрашивается, примонтировать ли сразу).
* `agsekit removemount [<путь>] [--config <путь>] [--vm <имя_ВМ>] [-y] [--debug]` — удаляет монтирование из YAML-конфига (путь ищется в `--config`, `CONFIG_PATH`, `~/.config/agsekit/config.yaml`). Если `<путь>` не указан, команда предлагает выбрать запись из списка монтирований. Когда несколько монтирований имеют одинаковый `source`, используйте `--vm` для уточнения. Перед сохранением CLI выводит выбранную запись и запрашивает подтверждение, если не указан `-y`; также создаётся резервная копия конфига с временной меткой и сохраняются комментарии. CLI всегда сначала выполняет размонтирование; если отмонтировать не удалось, конфиг не изменяется.

### Бэкапы

#### Разовая резервная копия

`agsekit backup-once --source-dir <путь> --dest-dir <путь> [--exclude <паттерн> ...] [--progress]` — однократный запуск резервного копирования исходной директории в указанную папку с помощью `rsync`.
Команда создаёт каталог с отметкой времени и суффиксом `-partial`, поддерживает инкрементальные копии через `--link-dest` на предыдущий бэкап и учитывает списки исключений из `.backupignore` и аргументов `--exclude`. После завершения выполнения временная папка переименовывается в финальную с тем же timestamp без суффикса. Если изменений относительно последнего бэкапа нет, новый снапшот не создаётся, и утилита сообщает об отсутствии обновлений. Флаг `--progress` прокидывает параметры прогресса для rsync и отображает свою консольную шкалу во время копирования.

Примеры строк для `.backupignore`:
```
# исключить виртуальные окружения и зависимости
venv/
node_modules/

# игнорировать временные и лог-файлы по маске
*.log
*.tmp

# оставить конкретный файл внутри исключённой папки
!logs/important.log

# пропустить артефакты сборки документации
docs/build/
```

Бэкапы используют `rsync` с инкрементальными ссылками (`--link-dest`) на предыдущую копию: если изменилась только часть файлов, новый снимок хранит лишь обновлённые данные, а неизменённые файлы хранятся как hardlink'и к предыдущему снимку. Это позволяет держать цепочку датированных директорий и экономить место при редких изменениях.

#### Повторяющиеся бэкапы

* `agsekit backup-repeated --source-dir <путь> --dest-dir <путь> [--exclude <паттерн> ...] [--interval <минуты>] [--max-backups <число>] [--backup-clean-method <tail|thin>] [--skip-first]` — выполняет бэкап сразу, а затем повторяет его каждые указанное число минут (по умолчанию пять минут). С `--skip-first` первый запуск пропускается, цикл стартует после ожидания указанного интервала. После каждого бэкапа выводится сообщение `Done, waiting N minutes` с фактическим интервалом.
* `agsekit backup-repeated-mount --mount <путь> [--config <path>]` — ищет монтирование по `source` в конфиге (порядок поиска: `--config`, `CONFIG_PATH`, `~/.config/agsekit/config.yaml`) и запускает повторяющиеся бэкапы с путями и интервалом из конфига. При единственном монтировании `--mount` можно не указывать; если записей несколько, потребуется выбрать одну.
* `agsekit backup-repeated-all [--config <path>]` — читает все монтирования из конфига (порядок поиска тот же: `--config`, `CONFIG_PATH`, `~/.config/agsekit/config.yaml`) и запускает параллельные циклы бэкапов для каждого в рамках одного процесса. Остановите циклы комбинацией Ctrl+C.

#### Очистка бэкапов

* `agsekit backup-clean <mount_source> [<keep>] [<method>] [--config <path>]` — удаляет старые снапшоты из каталога бэкапов для монтирования, чей `source` совпадает с `<mount_source>` в конфиге (порядок поиска: `--config`, `CONFIG_PATH`, `~/.config/agsekit/config.yaml`). `<keep>` по умолчанию равен 50 и определяет, сколько последних копий оставить. `<method>` по умолчанию `thin`: он сохраняет три последних бэкапа в свежих интервалах и затем логарифмически прореживает более старые копии, делая их реже по мере удаления в прошлое.

### Установка агентов

* `agsekit install-agents <agent_name> [<vm>|--all-vms] [--config <path>] [--proxychains <значение>] [--debug]` — выполняет подготовленный playbook установки выбранного типа агента внутри указанной ВМ (или ВМ по умолчанию для агента, если она не указана). Если в конфиге описан единственный агент, имя можно не передавать — он будет выбран автоматически. Укажите `--proxychains <scheme://host:port>`, чтобы временно задать прокси для установки, или `--proxychains ""`, чтобы проигнорировать настройку на один запуск.
* `agsekit install-agents --all-agents [--all-vms] [--config <path>] [--proxychains <значение>] [--debug]` — устанавливает все описанные агенты либо в их ВМ по умолчанию, либо во все ВМ при флаге `--all-vms`.

Playbook установки лежат в `agsekit_cli/ansible/agents/`: `codex` ставит npm-CLI, `codex-glibc` собирает Rust-версию с glibc и кладёт бинарник под именем `codex-glibc`, а `qwen` и `claude` повторяют свои типовые шаги (playbook `qwen` устанавливает qwen-code CLI). Для `claude` рабочий бинарник — `claude`. Другие типы пока не поддерживаются.

### Запуск агентов

* `agsekit run <agent_name> [<source_dir>|--vm <vm_name>] [--config <path>] [--proxychains <значение>] [--disable-backups] [--skip-default-args] [--debug] -- <agent_args...>` — запускает интерактивную команду агента внутри Multipass. Переменные окружения из конфига передаются процессу. Если указан `source_dir` из списка монтирований, агент стартует в смонтированном каталоге внутри соответствующей ВМ. Если `source_dir` не указан, `agsekit` сначала пытается определить mount по текущей директории и использует его при совпадении; если совпадения нет, запуск происходит в домашней директории ВМ по умолчанию. Без флага `--disable-backups` для выбранного монтирования поднимаются фоновые повторяющиеся бэкапы на время работы агента. При отсутствии готовых снапшотов CLI сперва сделает первый бэкап с прогресс-баром, затем запустит агента и циклический бэкап с пропуском первого запуска. Аргументы из `agents.<имя>.default-args` добавляются, если не указан `--skip-default-args`; если пользователь уже передал опцию с тем же именем (например, `--openai-api-key`), значение по умолчанию пропускается. Если у выбранного монтирования задано `mounts[].allowed_agents`, запуск `run` разрешён только для этих имён агентов. Флаг `--debug` выводит запускаемые команды, коды завершения и захваченные `stdout`/`stderr`, помогая отладить запуск. Флаг `--proxychains <scheme://host:port>` позволяет временно переопределить значение из конфига; пустая строка отключает прокси на один запуск.

### Интерактивный режим

В TTY не обязательно каждый раз вводить полные команды: CLI может провести вас через интерактивное меню и подставить параметры.

* Запустите `agsekit` без аргументов, чтобы открыть интерактивное меню, выбрать команду и указать параметры (путь к конфигу, монтирования, параметры агента и т.д.).
* Начните команду без обязательных аргументов (например, `agsekit run`), чтобы автоматически перейти в интерактивный режим после подсказки о нехватке параметров. Используйте `--non-interactive`, если вам нужен обычный вывод помощи вместо вопросов.

## Конфигурация YAML

Файл конфигурации (ищется в `--config`, `CONFIG_PATH` или `~/.config/agsekit/config.yaml`) описывает параметры ВМ, монтируемые директории и любые настройки `cloud-init`. Базовый пример есть в `config-example.yaml`:

```yaml
vms: # параметры виртуальных машин (можно иметь несколько)
  agent-ubuntu: # имя виртуальной машины
    cpu: 2      # количество vCPU
    ram: 4G     # объём оперативной памяти (поддерживаются 2G, 4096M и т.п.)
    disk: 20G   # размер диска
    proxychains: "" # укажите адрес прокси (scheme://host:port); agsekit сам создаст временный proxychains.conf и обернёт команды Multipass
    cloud-init: {} # здесь можно разместить стандартный конфиг cloud-init, но он не обязателен
    port-forwarding: # Проброс портов между хостом и ВМ
      - type: remote # Открыть порт в ВМ, и пробрасывать соединения к нему на порт открытый на хостовой машине
        host-addr: 127.0.0.1:80
        vm-addr: 127.0.0.1:8080
      - type: local # Открыть порт на хостовой машине, и пробрасывать соединения к нему на порт в ВМ
        host-addr: 0.0.0.0:15432
        vm-addr: 127.0.0.1:5432
      - type: socks5 # Открыть в ВМ порт socks5-proxy который будет вести в сети хостовой машины
        vm-addr: 127.0.0.1:8088
    install: # комплекты ПО, которые будут установлены в ВМ при create-vm/create-vms
      - python        # pyenv + последняя стабильная версия Python
      - nodejs:20     # nvm + Node.js 20
      - rust          # rustup + toolchain
mounts:
  - source: /host/path/project            # путь к исходной папке на хосте
    target: /home/ubuntu/project          # точка монтирования внутри ВМ; если не указана, будет /home/ubuntu/<имя_папки_source>
    backup: /host/backups/project         # каталог для бэкапов; если не указан, будет backups-<имя_папки> рядом с source
    allowed_agents: qwen, codex           # опционально: также можно [qwen, codex]; пробелы после запятых игнорируются
    interval: 5                           # интервал бэкапа в минутах; по умолчанию 5
    max_backups: 100                      # сколько снапшотов хранить; по умолчанию 100
    backup_clean_method: tail             # метод очистки (tail или thin); по умолчанию tail
    vm: agent-ubuntu # имя VM, если не указан - берётся первая VM из конфигурации
agents:
  qwen: # имя агента, можно добавить столько, сколько нужно
    type: qwen # тип агента: qwen (ставит и использует бинарник qwen), codex, codex-glibc (бинарник codex-glibc) или claude
    env: # произвольные переменные окружения, которые будут переданы агенту
      OPENAI_API_KEY: "my_local_key"
      OPENAI_BASE_URL: "https://127.0.0.1:11556/v1"
      OPENAI_MODEL: "Qwen/Qwen3-Coder-30B-A3B-Instruct-FP8"
    default-args: # аргументы, которые будут переданы агенту, если пользователь их не переопределил
      - "--openai-api-key=my_local_key"
      - "--openai-base-url=https://127.0.0.1:11556/v1"
    vm: qwen-ubuntu # ВМ по умолчанию для запуска агента; если не указана, берётся ВМ из монтирования или первая в списке
  codex:
    type: codex 
  claude:
    type: claude
  codex2:
    type: codex-glibc
```

### Комплекты установки для ВМ

В каждой ВМ можно указать список `install` — это наборы ПО, которые будут устанавливаться при `agsekit create-vm` / `create-vms`. Каждый комплект реализован как идемпотентный bash-скрипт и может зависеть от других (например, `python` сначала ставит `pyenv`). Имя может включать версию после `:`, если комплект это поддерживает. Доступные комплекты:

* `pyenv` — устанавливает pyenv с зависимостями для сборки и добавляет его в `~/.profile`, `~/.bashrc`, `~/.bash_profile`.
* `nvm` — устанавливает nvm и добавляет его в `~/.profile`, `~/.bashrc`, `~/.bash_profile`.
* `python` — устанавливает pyenv и последнюю стабильную версию Python.
* `python:<версия>` — устанавливает pyenv и указанную версию Python (например, `python:3.12.4`).
* `nodejs` — устанавливает nvm и последнюю LTS-версию Node.js.
* `nodejs:<версия>` — устанавливает nvm и указанную версию Node.js (например, `nodejs:20`).
* `rust` — устанавливает rustup с toolchain.
* `golang` — устанавливает Go toolchain через apt.
* `docker` — устанавливает Docker Engine и Docker Compose через apt-репозиторий Docker.

Запустите `agsekit list-bundles`, чтобы получить актуальный список комплектов и описаний.

> **Примечание.** Для `source` и `target` лучше использовать пути только из ASCII-символов: AppArmor может не позволить смонтировать каталоги с не-ASCII символами в пути.

## Локализация

CLI читает системную локаль и по умолчанию показывает английские сообщения, если поддерживаемый язык не найден. Поведение можно переопределить переменной окружения `AGSEKIT_LANG`:

```bash
AGSEKIT_LANG=ru agsekit --help
```
