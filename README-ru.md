[English README](README.md)

# Agent Safety Kit

Набор инструментов для запуска AI-агентов в изолированной среде внутри виртуальной машины Multipass.

## Немного ликбеза, если вы не понимаете зачем это:

<img width="437" height="379" alt="image" src="https://github.com/user-attachments/assets/c3486072-e96a-4197-8b1f-d6ac228c2cc6" />

Немного ссылок (нагуглить такого можно море):

* [Qwen Coder agent destroys working builds](https://github.com/QwenLM/qwen-code/issues/354)
* [Codex keeps deleting unrelated and uncommitted files! even ignoring rejected requests](https://github.com/openai/codex/issues/4969)
* [comment: qwen-code CLI destroyed my entire project, deleted important files](https://www.reddit.com/r/DeepSeek/comments/1mmfjsl/right_now_qwen_is_the_best_model_they_have_the/)
* [Claude Code deleted my entire workspace, here's the proof](https://www.reddit.com/r/ClaudeAI/comments/1m299f5/claude_code_deleted_my_entire_workspace_heres_the/)
* [I Asked Claude Code to Fix All Bugs, and It Deleted the Whole Repo](https://levelup.gitconnected.com/i-asked-claude-code-to-fix-all-bugs-and-it-deleted-the-whole-repo-e7f24f5390c5)
* [Codex has twice deleted and corrupted my files (r/ClaudeAI comment)](https://www.reddit.com/r/ClaudeAI/comments/1nhvyu0/openai_drops_gpt5_codex_cli_right_after/)

Понятно, что "все понимают" и "у всех должны быть бэкапы" и "у вас всё должно быть в git", но пока "песочница" которую предоставляют консольные ИИ-агенты не имеет встроенных снапшотов, позволяющих откатываться назад после каждой правки, сделанной ИИ, нужен некий инструмент, который позволит сделать это самостоятельно.

## Ключевые идеи

- Агент работает только в виртуальной машине.
- Виртуальная машина запускается через Multipass (это простой инструмент от Canonical для запуска ubuntu в виртуалке в 1 команду)
- Внутрь ВМ монтируются проектные папки из указанной пользователем директории; параллельно запускается автоматическое резервное копирование в соседнюю папку с настраиваемой частотой (по умолчанию раз в пять минут и только при изменениях), использующее `rsync` и hardlink'и для экономии места.
- Настройки виртуальной машины, монтирования и cloud-init задаются в YAML-конфиге.
- Агент можно запускать, не входя в гостевую систему через `multipass shell` — фактически он всё равно исполняется внутри ВМ.
- Команды Multipass и запуски агента можно оборачивать в proxychains: укажите URL прокси для ВМ или временно переопределите его флагом `--proxychains`, CLI автоматически создаст временный конфиг proxychains.

## Быстрый старт

1. Склонируйте репозиторий и перейдите в него:
   ```bash
   git clone https://github.com/MihanEntalpo/agent-safety-kit/
   cd agent-safety-kit
   ```

2. Подготовьте Python-окружение и установите пакет в виртуальное окружение (требуется Python 3.9 или новее):
   ```bash
   python3 -m venv ./venv
   source ./venv/bin/activate
   pip install .
   ```
   Так команда `agsekit` станет доступна внутри виртуального окружения.

3. Создайте YAML-конфигурацию (CLI ищет путь в `--config`, затем в `CONFIG_PATH`, затем в `~/.config/agsekit/config.yaml`):
   ```bash
   mkdir -p ~/.config/agsekit
   cp config-example.yaml ~/.config/agsekit/config.yaml
   # отредактируйте параметры vms/mounts/cloud-init под себя
   ```
   Можно также запустить `agsekit config-gen`, чтобы ответить на вопросы и сохранить конфиг (по умолчанию в `~/.config/agsekit/config.yaml`; чтобы перезаписать существующий файл, добавьте `--overwrite`).

4. Установите необходимые системные зависимости (в частности, Multipass; потребуется sudo, работает пока только в debian-based системах):
   ```bash
   agsekit prepare
   ```

5. Создайте виртуальные машины с параметрами из YAML:
   ```bash
   agsekit create-vms
   ```

   Если нужно развернуть только одну ВМ, используйте `agsekit create-vm <имя>`. Когда в конфиге описана единственная ВМ, имя можно не указывать — она будет выбрана автоматически. Если ВМ уже существует, команда сравнит заданные ресурсы с текущими и сообщит об отличающихся параметрах. Пока изменить параметры уже работающей машины нельзя

6. Смонтируйте папки (предполагается, что монтирования уже описаны в YAML):
   ```bash
   agsekit mount --all
   ```

7. Установите все описанные агенты в их ВМ по умолчанию:
   ```bash
   agsekit install-agents --all-agents
   ```

8. Запустите агента внутри его ВМ (пример запускает `qwen` в папке, куда смонтирована `/host/path/project`, бэкапы включены по умолчанию):
   ```bash
   agsekit run qwen /host/path/project --vm agent-ubuntu
   ```
   При первом запуске с включёнными бэкапами утилита сначала сделает первичную копию с прогресс-баром, поэтому дождитесь её завершения перед стартом агента.

## Команды agsekit

### Подготовка и жизненный цикл ВМ

* `agsekit prepare` — устанавливает системные зависимости (включая Multipass; требует sudo и работает пока только в debian-based системах).
* `agsekit config-gen [--config <path>] [--overwrite]` — интерактивный мастер, который задаёт вопросы про ВМ, монтирования и агентов и записывает YAML-конфиг в выбранный путь (по умолчанию `~/.config/agsekit/config.yaml`). Без флага `--overwrite` команда предупредит о существующем файле.
* `agsekit create-vms` — создаёт все ВМ, указанные в YAML-конфигурации.
* `agsekit create-vm <name>` — запускает только одну ВМ. Если в конфиге указана единственная ВМ, имя можно не передавать — она выберется автоматически. Если ВМ уже существует, команда сравнит желаемые ресурсы с текущими и сообщит об отличиях. Изменять ресурсы уже созданной ВМ пока нельзя.
* `agsekit shell [<vm_name>] [--config <path>]` — открывает интерактивную сессию `multipass shell` внутри выбранной ВМ и применяет настроенный проброс портов. Если в конфиге только одна ВМ, CLI подключится к ней даже без `vm_name`. Когда ВМ несколько и команда выполняется в TTY, CLI предложит выбрать нужную; в неинтерактивном режиме имя ВМ обязательно.
* `agsekit ssh <vm_name> [--config <path>] [<ssh_args...>]` — подключается к ВМ по SSH с ключом `~/.config/agsekit/ssh/id_rsa` и передаёт любые дополнительные аргументы напрямую в `ssh` (например `-L`, `-R`, `-N`).
* `agsekit portforward [--config <path>]` — запускает отдельный `agsekit ssh`-туннель для каждой ВМ с правилами `port-forwarding`, следит за процессами и перезапускает их при завершении. Остановку выполняйте через Ctrl+C для корректного завершения туннелей.
* `agsekit start-vm <vm_name> [--config <path>]` — запускает выбранную ВМ из конфигурации. Если в конфиге только одна ВМ, имя можно опустить.
* `agsekit start-vm --all-vms [--config <path>]` — запускает все ВМ, описанные в конфиге.
* `agsekit stop-vm <vm_name> [--config <path>]` — останавливает выбранную ВМ из конфигурации. Если в конфиге только одна ВМ, имя можно опустить.
* `agsekit stop-vm --all-vms [--config <path>]` — останавливает все ВМ, описанные в конфиге.

### Управление монтированием

* `agsekit mount --source-dir <path> [--config <path>]` — монтирует директорию с `source`, описанную в конфиге (путь ищется в `--config`, `CONFIG_PATH`, `~/.config/agsekit/config.yaml`), в соответствующую ВМ через `multipass mount`. Флаг `--all` монтирует все записи из конфига. Когда в конфиге только одно монтирование, команду можно вызывать без `--source-dir` или `--all`.
* `agsekit umount --source-dir <path> [--config <path>]` — размонтирует директорию `source` из конфига (или `CONFIG_PATH`/`--config`); `--all` размонтирует все указанные пути. Если монтирование единственное, флаги можно не указывать.

### Бэкапы

#### Разовая резервная копия

`agsekit backup-once --source-dir <путь> --dest-dir <путь> [--exclude <паттерн> ...] [--progress]` — однократный запуск резервного копирования исходной директории в указанную папку с помощью `rsync`.
Команда создаёт каталог с отметкой времени и суффиксом `-partial`, поддерживает инкрементальные копии через `--link-dest` на предыдущий бэкап и учитывает списки исключений из `.backupignore` и аргументов `--exclude`. После завершения выполнения временная папка переименовывается в финальную с тем же timestamp без суффикса. Если изменений относительно последнего бэкапа нет, новый снапшот не создаётся, и утилита сообщает об отсутствии обновлений. Флаг `--progress` прокидывает параметры прогресса для rsync и отображает свою консольную шкалу во время копирования.

Примеры строк для `.backupignore`:
```
# исключить виртуальные окружения и зависимости
venv/
node_modules/

# игнорировать временные и лог-файлы по маске
*.log
*.tmp

# оставить конкретный файл внутри исключённой папки
!logs/important.log

# пропустить артефакты сборки документации
docs/build/
```

Бэкапы используют `rsync` с инкрементальными ссылками (`--link-dest`) на предыдущую копию: если изменилась только часть файлов, новый снимок хранит лишь обновлённые данные, а неизменённые файлы хранятся как hardlink'и к предыдущему снимку. Это позволяет держать цепочку датированных директорий и экономить место при редких изменениях.

#### Повторяющиеся бэкапы

* `agsekit backup-repeated --source-dir <путь> --dest-dir <путь> [--exclude <паттерн> ...] [--interval <минуты>] [--skip-first]` — выполняет бэкап сразу, а затем повторяет его каждые указанное число минут (по умолчанию пять минут). С `--skip-first` первый запуск пропускается, цикл стартует после ожидания указанного интервала. После каждого бэкапа выводится сообщение `Done, waiting N minutes` с фактическим интервалом.
* `agsekit backup-repeated-mount --mount <путь> [--config <path>]` — ищет монтирование по `source` в конфиге (порядок поиска: `--config`, `CONFIG_PATH`, `~/.config/agsekit/config.yaml`) и запускает повторяющиеся бэкапы с путями и интервалом из конфига. При единственном монтировании `--mount` можно не указывать; если записей несколько, потребуется выбрать одну.
* `agsekit backup-repeated-all [--config <path>]` — читает все монтирования из конфига (порядок поиска тот же: `--config`, `CONFIG_PATH`, `~/.config/agsekit/config.yaml`) и запускает параллельные циклы бэкапов для каждого в рамках одного процесса. Остановите циклы комбинацией Ctrl+C.

### Установка агентов

* `agsekit install-agents <agent_name> [<vm>|--all-vms] [--config <path>] [--proxychains <значение>]` — выполняет подготовленный скрипт установки выбранного типа агента внутри указанной ВМ (или ВМ по умолчанию для агента, если она не указана). Если в конфиге описан единственный агент, имя можно не передавать — он будет выбран автоматически. Укажите `--proxychains <scheme://host:port>`, чтобы временно задать прокси для установки, или `--proxychains ""`, чтобы проигнорировать настройку на один запуск.
* `agsekit install-agents --all-agents [--all-vms] [--config <path>] [--proxychains <значение>]` — устанавливает все описанные агенты либо в их ВМ по умолчанию, либо во все ВМ при флаге `--all-vms`.

Скрипты установки лежат в `agsekit_cli/agent_scripts/`: `codex` ставит npm-CLI, `codex-glibc` собирает Rust-версию с glibc и кладёт бинарник под именем `codex-glibc`, а `qwen` и `claude-code` повторяют свои типовые шаги (скрипт `qwen` устанавливает qwen-code CLI). Другие типы пока не поддерживаются.

### Запуск агентов

* `agsekit run <agent_name> [<source_dir>|--vm <vm_name>] [--config <path>] [--proxychains <значение>] [--disable-backups] [--debug] -- <agent_args...>` — запускает интерактивную команду агента внутри Multipass. Переменные окружения из конфига передаются процессу. Если указан `source_dir` из списка монтирований, агент стартует в смонтированном каталоге внутри соответствующей ВМ; иначе запуск происходит в домашней директории ВМ по умолчанию. Без флага `--disable-backups` для выбранного монтирования поднимаются фоновые повторяющиеся бэкапы на время работы агента. При отсутствии готовых снапшотов CLI сперва сделает первый бэкап с прогресс-баром, затем запустит агента и циклический бэкап с пропуском первого запуска. Флаг `--debug` выводит все внешние команды перед их выполнением, помогая отладить запуск. Флаг `--proxychains <scheme://host:port>` позволяет временно переопределить значение из конфига; пустая строка отключает прокси на один запуск.

### Интерактивный режим

В TTY не обязательно каждый раз вводить полные команды: CLI может провести вас через интерактивное меню и подставить параметры.

* Запустите `agsekit` без аргументов, чтобы открыть интерактивное меню, выбрать команду и указать параметры (путь к конфигу, монтирования, параметры агента и т.д.).
* Начните команду без обязательных аргументов (например, `agsekit run`), чтобы автоматически перейти в интерактивный режим после подсказки о нехватке параметров. Используйте `--non-interactive`, если вам нужен обычный вывод помощи вместо вопросов.

## Конфигурация YAML

Файл конфигурации (ищется в `--config`, `CONFIG_PATH` или `~/.config/agsekit/config.yaml`) описывает параметры ВМ, монтируемые директории и любые настройки `cloud-init`. Базовый пример есть в `config-example.yaml`:

```yaml
vms: # параметры виртуальных машин (можно иметь несколько)
  agent-ubuntu: # имя виртуальной машины
    cpu: 2      # количество vCPU
    ram: 4G     # объём оперативной памяти (поддерживаются 2G, 4096M и т.п.)
    disk: 20G   # размер диска
    proxychains: "" # укажите адрес прокси (scheme://host:port); agsekit сам создаст временный proxychains.conf и обернёт команды Multipass
    cloud-init: {} # здесь можно разместить стандартный конфиг cloud-init, но он не обязателен
    port-forwarding: # Проброс портов между хостом и ВМ
      - type: remote # Открыть порт в ВМ, и пробрасывать соединения к нему на порт открытый на хостовой машине
        host-addr: 127.0.0.1:8080
        vm-addr: 127.0.0.1:80
      - type: local # Открыть порт на хостовой машине, и пробрасывать соединения к нему на порт в ВМ
        host-addr: 0.0.0.0:15432
        vm-addr: 127.0.0.1:5432
      - type: socks5 # Открять в ВМ порт socks5-proxy который будет вести в сети хостовой машины
        vm-addr: 127.0.0.1:8088
mounts:
  - source: /host/path/project            # путь к исходной папке на хосте
    target: /home/ubuntu/project          # точка монтирования внутри ВМ; если не указана, будет /home/ubuntu/<имя_папки_source>
    backup: /host/backups/project         # каталог для бэкапов; если не указан, будет backups-<имя_папки> рядом с source
    interval: 5                           # интервал бэкапа в минутах; по умолчанию 5
    vm: agent-ubuntu # имя VM, если не указан - берётся первая VM из конфигурации
agents:
  qwen: # имя агента, можно добавить столько, сколько нужно
    type: qwen # тип агента: qwen (ставит и использует бинарник qwen), codex, codex-glibc (бинарник codex-glibc) или claude-code (другие пока не поддерживаются)
    env: # произвольные переменные окружения, которые будут переданы агенту
      OPENAI_API_KEY: "my_local_key"
      OPENAI_BASE_URL: "https://127.0.0.1:11556/v1"
      OPENAI_MODEL: "Qwen/Qwen3-Coder-30B-A3B-Instruct-FP8"
    vm: qwen-ubuntu # ВМ по умолчанию для запуска агента; если не указана, берётся ВМ из монтирования или первая в списке
  codex:
    type: codex 
  claude:
    type: claude-code
  codex2:
    type: codex-glibc
```

> **Примечание.** Для `source` и `target` лучше использовать пути только из ASCII-символов: AppArmor может не позволить смонтировать каталоги с не-ASCII символами в пути.

## Резервное копирование

### Разовая резервная копия

`agsekit backup-once --source-dir <путь> --dest-dir <путь> [--exclude <паттерн> ...] [--progress]` — однократный запуск резервного копирования исходной директории в указанную папку с помощью `rsync`.
Команда создаёт каталог с отметкой времени и суффиксом `-partial`, поддерживает инкрементальные копии через `--link-dest` на предыдущий бэкап и учитывает списки исключений из `.backupignore` и аргументов `--exclude`. После завершения выполнения временная папка переименовывается в финальную с тем же timestamp без суффикса. Если изменений относительно последнего бэкапа нет, новый снапшот не создаётся, и утилита сообщает об отсутствии обновлений. Флаг `--progress` прокидывает параметры прогресса для rsync и отображает свою консольную шкалу во время копирования.

Примеры строк для `.backupignore`:
```
# исключить виртуальные окружения и зависимости
venv/
node_modules/

# игнорировать временные и лог-файлы по маске
*.log
*.tmp

# вернуть в бэкап конкретный файл внутри исключённой папки
!logs/important.log

# пропустить артефакты сборки документации
docs/build/
```

Бэкап использует `rsync` с инкрементальными ссылками (`--link-dest`) на предыдущую копию: если изменился только небольшой набор файлов, в новой копии хранятся лишь изменённые данные, а неизменённые файлы представляют собой hardlink'и на прошлый снапшот. Это позволяет поддерживать цепочку датированных каталогов, занимая минимум места при редких изменениях.

### Циклические бэкапы

* `agsekit backup-repeated --source-dir <путь> --dest-dir <путь> [--exclude <паттерн> ...] [--interval <минуты>] [--skip-first]` — сразу делает бэкап и повторяет его каждые `interval` минут (по умолчанию каждые пять минут). С `--skip-first` первый запуск пропускается, цикл стартует после ожидания интервала. После каждого запуска выводит `Done, waiting N minutes` с фактическим интервалом.
* `agsekit backup-repeated-mount --mount <путь> [--config <путь>]` — ищет монтирование по полю `source` в файле конфигурации (порядок поиска: `--config`, `CONFIG_PATH`, `~/.config/agsekit/config.yaml`) и запускает циклические бэкапы с путями и интервалом из конфига. При единственном монтировании флаг `--mount` можно не указывать; если записей несколько, потребуется выбрать одну.
* `agsekit backup-repeated-all [--config <путь>]` — читает все монтирования из конфига (порядок поиска: `--config`, `CONFIG_PATH`, `~/.config/agsekit/config.yaml`) и поднимает одновременные циклические бэкапы для каждого из них в одном процессе. Остановить можно через Ctrl+C.

### Управление монтированиями

* `agsekit mount --source-dir <путь> [--config <путь>]` — монтирует директорию с `source` из файла конфигурации (порядок поиска: `--config`, `CONFIG_PATH`, `~/.config/agsekit/config.yaml`) в её ВМ через `multipass mount`. Флаг `--all` монтирует все записи из конфига. Если в конфиге только одно монтирование, команду можно вызывать без `--source-dir` или `--all`.
* `agsekit umount --source-dir <путь> [--config <путь>]` — отмонтирует директорию с `source` из конфига (или `CONFIG_PATH`/`--config`); `--all` отмонтирует все настроенные пути. При единственном монтировании флаги можно не указывать.

### Доступ к shell ВМ

* `agsekit shell [<vm_name>] [--config <путь>]` — открывает интерактивную сессию `multipass shell` внутри выбранной ВМ и применяет настроенный проброс портов. Если в конфиге есть только одна ВМ, CLI подключится к ней даже без `vm_name`. Если ВМ несколько и команда запускается в TTY, CLI предложит выбрать одну; в неинтерактивном режиме имя ВМ обязательно.
* `agsekit ssh <vm_name> [--config <путь>] [<ssh_args...>]` — использует подготовленный ключ `~/.config/agsekit/ssh/id_rsa` для подключения к ВМ по SSH и передаёт дополнительные аргументы в `ssh`, чтобы можно было пробрасывать порты или работать в режиме `-N`.

### Управление жизненным циклом ВМ

* `agsekit start-vm <vm_name> [--config <путь>]` — запускает указанную ВМ из конфигурации. Если в конфиге только одна ВМ, имя можно опустить.
* `agsekit start-vm --all-vms [--config <путь>]` — запускает все ВМ, описанные в конфиге.
* `agsekit stop-vm <vm_name> [--config <путь>]` — останавливает указанную ВМ из конфигурации. Если в конфиге только одна ВМ, имя можно опустить.
* `agsekit stop-vm --all-vms [--config <путь>]` — останавливает все ВМ, описанные в конфиге.

### Установка агентов

* `agsekit install-agents <agent_name> [<vm>|--all-vms] [--config <path>] [--proxychains <значение>]` — запускает подготовленный скрипт установки для выбранного типа агента внутри указанной ВМ (или ВМ по умолчанию для агента, если не задана). Если в конфиге описан единственный агент, имя можно не указывать — он выберется автоматически. `--proxychains <scheme://host:port>` позволяет временно заменить прокси, а `--proxychains ""` отключает обёртку на одну установку.
* `agsekit install-agents --all-agents [--all-vms] [--config <path>] [--proxychains <значение>]` — устанавливает всех описанных агентов либо в их ВМ по умолчанию, либо во все ВМ при указании `--all-vms`.

Скрипты установки лежат в `agsekit_cli/agent_scripts/`: `codex` ставит npm-CLI, `codex-glibc` собирает Rust-версию с glibc и кладёт бинарник под именем `codex-glibc`, а `qwen` и `claude-code` повторяют свои типовые шаги (скрипт `qwen` устанавливает qwen-code CLI). Другие типы агентов пока не поддерживаются.

### Запуск агентов

* `agsekit run <agent_name> [<source_dir>|--vm <vm_name>] [--config <path>] [--proxychains <значение>] [--disable-backups] [--debug] -- <agent_args...>` — запускает интерактивную команду агента внутри Multipass. Переменные окружения из конфига передаются процессу. Если указан `source_dir` из списка монтирований, запуск произойдёт в соответствующей ВМ и целевой директории монтирования; иначе агент стартует в домашней папке ВМ по умолчанию. При отсутствии флага `--disable-backups` параллельно поднимается фоновый повторяющийся бэкап для выбранного монтирования на время работы агента. Если готовых снимков ещё нет, CLI сначала сделает первый бэкап с прогресс-баром, затем запустит агента и циклический бэкап с пропуском первого запуска. Флаг `--debug` выводит все внешние команды перед их выполнением, упрощая отладку запуска. `--proxychains <scheme://host:port>` временно меняет значение из конфига, пустая строка отключает прокси.

### Интерактивный режим

В интерактивном терминале не обязательно писать команды целиком: CLI может пройтись по шагам и собрать параметры за вас.

* Запустите `agsekit` без аргументов, чтобы открыть интерактивное меню, выбрать команду и указать настройки вроде пути к конфигу, монтирований или параметров агента.
* Запустите команду без обязательных аргументов (например, `agsekit run`), чтобы после подсказки о нехватке параметров автоматически перейти в интерактивный сценарий. Если подсказки не нужны, добавьте `--non-interactive`, чтобы увидеть обычную справку вместо опросов.
